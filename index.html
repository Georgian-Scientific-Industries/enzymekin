<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michaelis-Menten Enzyme Kinetics Simulator</title>
    <link rel="icon" type="image/svg+xml" href="" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class xt{constructor(){this.parameters={km:2,kcat:100,ki:1,k1:1,kMinus1:100,k2:100},this.state={substrate:5,enzyme:.1,product:0,enzymeSubstrateComplex:0,inhibitor:0,enzymeInhibitorComplex:0,enzymeSubstrateInhibitorComplex:0,freeEnzyme:.1},this.time=0,this.timeStep=.01,this.inhibitionType="none",this.isRunning=!1,this.dataLog={time:[],substrate:[],product:[],enzymeSubstrateComplex:[],velocity:[]},this.clearDataLog()}calculateVelocity(){const t=this.state.substrate,e=this.state.inhibitor,a=this.state.enzyme,i=this.parameters.kcat*a;let o=0;switch(this.inhibitionType){case"competitive":const s=this.parameters.km*(1+e/this.parameters.ki);o=i*t/(s+t);break;case"uncompetitive":const n=1+e/this.parameters.ki;o=i*t/(this.parameters.km+t*n);break;case"noncompetitive":const r=1+e/this.parameters.ki;o=i*t/((this.parameters.km+t)*r);break;case"none":default:o=i*t/(this.parameters.km+t);break}return o}getApparentKm(){const t=this.state.inhibitor;switch(this.inhibitionType){case"competitive":return this.parameters.km*(1+t/this.parameters.ki);case"uncompetitive":return this.parameters.km/(1+t/this.parameters.ki);case"noncompetitive":case"none":default:return this.parameters.km}}getApparentVmax(){const t=this.state.inhibitor,e=this.parameters.kcat*this.state.enzyme;switch(this.inhibitionType){case"competitive":return e;case"uncompetitive":case"noncompetitive":return e/(1+t/this.parameters.ki);case"none":default:return e}}calculateDerivatives(t){const{substrate:e,enzymeSubstrateComplex:a,freeEnzyme:i}=t,{k1:o,kMinus1:s,k2:n}=this.parameters,r=o/1e3,l=r*i*e-(s+n)*a,h=n*a/1e3,m=-r*i*e+s*a/1e3;return{dES_dt:l,dP_dt:h,dS_dt:m}}rungeKuttaStep(){const t=this.timeStep,e={...this.state};if(!isFinite(e.substrate)||!isFinite(e.enzymeSubstrateComplex)||!isFinite(e.freeEnzyme)||e.substrate<0){console.warn("Invalid simulation state detected, resetting..."),this.reset();return}const a=this.calculateDerivatives(e),i={ES:t*a.dES_dt,P:t*a.dP_dt,S:t*a.dS_dt};if(!isFinite(i.ES)||!isFinite(i.P)||!isFinite(i.S)){console.warn("Invalid derivatives detected, skipping step...");return}const o={...e,enzymeSubstrateComplex:Math.max(0,e.enzymeSubstrateComplex+i.ES/2),product:Math.max(0,e.product+i.P/2),substrate:Math.max(0,e.substrate+i.S/2)};o.freeEnzyme=Math.max(0,this.state.enzyme-o.enzymeSubstrateComplex);const s=this.calculateDerivatives(o),n={ES:t*s.dES_dt,P:t*s.dP_dt,S:t*s.dS_dt},r={...e,enzymeSubstrateComplex:Math.max(0,e.enzymeSubstrateComplex+n.ES/2),product:Math.max(0,e.product+n.P/2),substrate:Math.max(0,e.substrate+n.S/2)};r.freeEnzyme=Math.max(0,this.state.enzyme-r.enzymeSubstrateComplex);const l=this.calculateDerivatives(r),h={ES:t*l.dES_dt,P:t*l.dP_dt,S:t*l.dS_dt},m={...e,enzymeSubstrateComplex:Math.max(0,e.enzymeSubstrateComplex+h.ES),product:Math.max(0,e.product+h.P),substrate:Math.max(0,e.substrate+h.S)};m.freeEnzyme=Math.max(0,this.state.enzyme-m.enzymeSubstrateComplex);const f=this.calculateDerivatives(m),p={ES:t*f.dES_dt,P:t*f.dP_dt,S:t*f.dS_dt};this.state.enzymeSubstrateComplex=Math.max(0,this.state.enzymeSubstrateComplex+(i.ES+2*n.ES+2*h.ES+p.ES)/6),this.state.product=Math.max(0,this.state.product+(i.P+2*n.P+2*h.P+p.P)/6),this.state.substrate=Math.max(0,this.state.substrate+(i.S+2*n.S+2*h.S+p.S)/6),this.state.freeEnzyme=Math.max(0,this.state.enzyme-this.state.enzymeSubstrateComplex),this.state.enzymeSubstrateComplex>this.state.enzyme&&(this.state.enzymeSubstrateComplex=this.state.enzyme,this.state.freeEnzyme=0),(!isFinite(this.state.substrate)||!isFinite(this.state.product)||!isFinite(this.state.enzymeSubstrateComplex))&&(console.warn("NaN detected in simulation state, resetting..."),this.reset())}step(){this.isRunning&&(this.rungeKuttaStep(),this.time+=this.timeStep,this.logCurrentState())}logCurrentState(){this.dataLog.time.push(this.time),this.dataLog.substrate.push(this.state.substrate),this.dataLog.product.push(this.state.product),this.dataLog.enzymeSubstrateComplex.push(this.state.enzymeSubstrateComplex),this.dataLog.velocity.push(this.calculateVelocity())}clearDataLog(){this.dataLog.time=[],this.dataLog.substrate=[],this.dataLog.product=[],this.dataLog.enzymeSubstrateComplex=[],this.dataLog.velocity=[]}reset(){this.time=0,this.state.product=0,this.state.enzymeSubstrateComplex=0,this.state.freeEnzyme=this.state.enzyme,this.clearDataLog(),this.logCurrentState()}updateSubstrateConcentration(t){this.state.substrate=t}updateEnzymeConcentration(t){this.state.enzyme=t,this.state.freeEnzyme=t-this.state.enzymeSubstrateComplex}updateInhibitorConcentration(t){this.state.inhibitor=t}updateInhibitionType(t){this.inhibitionType=t}start(){this.isRunning=!0}pause(){this.isRunning=!1}exportData(){const t=["Time (ms)","Substrate (mM)","Product (mM)","ES Complex (μM)","Velocity (μM/ms)"],e=this.dataLog.time.map((a,i)=>[a.toFixed(3),this.dataLog.substrate[i].toFixed(3),this.dataLog.product[i].toFixed(3),this.dataLog.enzymeSubstrateComplex[i].toFixed(3),this.dataLog.velocity[i].toFixed(4)]);return[t,...e]}}class bt{constructor(){this.BASE_SPEED_MULTIPLIER=.75,this.parameters={S_concentration:20,E_concentration:1,I_concentration:0,inhibitor_type:"None",k_on_ES:.5,k_on_EI:.08,k_off_ES:.01,k_off_EI:.03,k_cat:.035,timeframe:500,time_step:.01,canvas_width:800,canvas_height:400},this.objects=[],this.results=[],this.time=0,this.lastRecordTime=0,this.isRunning=!1,this.preCalculatedData={timePoints:[],particleData:[],summaryData:[],isGenerated:!1,totalDuration:0},this.playbackState={isPlaying:!1,currentTime:0,playbackSpeed:1,mode:"live"},this.dataLog={time:[],molecularData:[],summary:[]},this.isPreCalculating=!1}getResponsiveSpeedMultiplier(){const t=this.parameters.canvas_width||800;let e;return t>=800?e=1:t>=600?e=.6:e=.3,this.BASE_SPEED_MULTIPLIER*e}getResponsiveBindingThreshold(t=25){const e=this.parameters.canvas_width||800;let a;return e>=800?a=1:e>=600?a=.6:a=.3,Math.max(5,t*a)}setParameters(t){const a=["S_concentration","E_concentration","I_concentration","inhibitor_type"].some(i=>t.hasOwnProperty(i)&&t[i]!==this.parameters[i]);this.parameters={...this.parameters,...t},a?(console.log("EnzymeKineticsSimulator: Significant parameter change detected, invalidating simulation data"),this.isPreCalculating=!1,this.preCalculatedData.isGenerated=!1,this.initializeObjects()):(t.canvas_width||t.canvas_height)&&(console.log("EnzymeKineticsSimulator: Canvas dimensions updated, preserving simulation data"),this.initializeObjects())}async preCalculateSimulation(t=null){this.isPreCalculating&&(console.warn("Pre-calculation already in progress, forcing reset and starting fresh..."),this.isPreCalculating=!1,this.preCalculatedData.isGenerated=!1),this.isPreCalculating=!0,this.preCalculatedData.isGenerated=!1,console.log("Pre-calculating simulation with 2 runs for averaging...");try{const e=performance.now(),a=2,i=[];for(let n=0;n<a;n++){if(!this.isPreCalculating){console.log("Pre-calculation cancelled during run",n+1);break}console.log(`Starting simulation run ${n+1}/${a}`);const r=await this.runSingleSimulation(t,n,a);r?i.push(r):console.warn(`Run ${n+1} failed to generate data`)}if(!this.isPreCalculating||i.length===0)return console.log("Pre-calculation was cancelled or failed - no valid runs collected"),this.isPreCalculating=!1,this.preCalculatedData.isGenerated=!1,null;this.calculateAveragedData(i);const s=performance.now()-e;return this.preCalculatedData.isGenerated=!0,this.isPreCalculating=!1,console.log(`Pre-calculation complete: 2 runs averaged, ${this.preCalculatedData.timePoints.length} frames in ${s.toFixed(2)}ms`),console.log("Memory: Only essential simulation data retained (no redundant individualRuns stored)"),this.preCalculatedData}catch(e){throw console.error("Pre-calculation failed with error:",e),this.isPreCalculating=!1,this.preCalculatedData.isGenerated=!1,e}}async runSingleSimulation(t=null,e=0,a=1){this.time=0,this.lastRecordTime=0,this.initializeObjects();const i={timePoints:[],particleData:[],summaryData:[]};let o=0;const s=Math.ceil(this.parameters.timeframe/this.parameters.time_step);for(;this.time<this.parameters.timeframe&&this.isPreCalculating;){if(this.simulateStepForPreCalculation(this.parameters.time_step),this.time-this.lastRecordTime>=.033&&(this.recordStateForRun(i),this.lastRecordTime=this.time),o++,t&&o%1e3===0){const n=(e+o/s)/a*100;t(n),await new Promise(r=>setTimeout(r,0))}this.time+=this.parameters.time_step}return this.isPreCalculating&&this.recordStateForRun(i),console.log(`Run ${e+1} complete: ${i.timePoints.length} frames`),i}recordStateForRun(t){const e=this.time,a=this.objects.map(o=>({id:o.id,type:o.type,unique_name:o.unique_name,x:o.x,y:o.y,vx:o.vx,vy:o.vy,bound:o.bound})),i=this.getSummary();t.timePoints.push(e),t.particleData.push([e,a]),t.summaryData.push([e,i])}calculateAveragedData(t){console.log("Calculating averaged data from",t.length,"runs");const e=t[0];this.preCalculatedData={timePoints:[...e.timePoints],particleData:[...e.particleData],summaryData:[],averagedData:[],isGenerated:!1,totalDuration:this.parameters.timeframe};const a=e.timePoints;for(let i=0;i<a.length;i++){const o=a[i],s={};["E","S","I","P","ES","EI","ESI"].forEach(n=>{let r=0,l=0;t.forEach(h=>{if(i<h.summaryData.length){const m=h.summaryData[i][1];r+=m[n]||0,l++}}),s[n]=l>0?r/l:0}),this.preCalculatedData.summaryData.push([o,s]),this.preCalculatedData.averagedData.push([o,s])}console.log("Averaged data calculated:",this.preCalculatedData.summaryData.length,"time points"),console.log("Essential data preserved: timePoints, particleData, summaryData, averagedData")}recordStateForPlayback(){const t=this.time,e=this.objects.map(i=>({id:i.id,type:i.type,unique_name:i.unique_name,x:i.x,y:i.y,vx:i.vx,vy:i.vy,bound:i.bound})),a=this.getSummary();this.preCalculatedData.timePoints.push(t),this.preCalculatedData.particleData.push([t,e]),this.preCalculatedData.summaryData.push([t,a])}getParticlesAtTime(t){var s;if(!this.preCalculatedData.isGenerated)return this.objects;const e=this.preCalculatedData.timePoints;if(e.length===0)return[];let a=0,i=e.length-1,o=0;for(;a<=i;){const n=Math.floor((a+i)/2),r=e[n];if(r===t){o=n;break}else r<t?(a=n+1,o=n):i=n-1}if(o+1<e.length){const n=Math.abs(e[o]-t);Math.abs(e[o+1]-t)<n&&(o=o+1)}return((s=this.preCalculatedData.particleData[o])==null?void 0:s[1])||[]}getSummaryAtTime(t){var s;if(!this.preCalculatedData.isGenerated)return this.getSummary();const e=this.preCalculatedData.timePoints;if(e.length===0)return{};let a=0,i=e.length-1,o=0;for(;a<=i;){const n=Math.floor((a+i)/2),r=e[n];if(r===t){o=n;break}else r<t?(a=n+1,o=n):i=n-1}if(o+1<e.length){const n=Math.abs(e[o]-t);Math.abs(e[o+1]-t)<n&&(o=o+1)}return((s=this.preCalculatedData.summaryData[o])==null?void 0:s[1])||{}}switchToPlaybackMode(){this.playbackState.mode="playback",this.playbackState.currentTime=0,this.playbackState.isPlaying=!1}switchToLiveMode(){this.playbackState.mode="live",this.initializeObjects()}playPlayback(){this.playbackState.mode==="playback"&&(this.playbackState.isPlaying=!0)}pausePlayback(){this.playbackState.isPlaying=!1}setPlaybackTime(t){this.playbackState.mode==="playback"&&(this.playbackState.currentTime=Math.max(0,Math.min(t,this.preCalculatedData.totalDuration)))}setPlaybackSpeed(t){this.playbackState.playbackSpeed=1}updatePlayback(t){this.playbackState.mode==="playback"&&this.playbackState.isPlaying&&(this.playbackState.currentTime+=t*this.playbackState.playbackSpeed,this.playbackState.currentTime>=this.preCalculatedData.totalDuration&&(this.playbackState.currentTime=0))}initializeObjects(){this.objects=[],this.object_counters={S:1,E:1,I:1,P:1,ES:1,EI:1,ESI:1};const t=10,e=Math.round(this.parameters.S_concentration*t),a=Math.round(this.parameters.E_concentration*t),i=this.parameters.inhibitor_type==="None"?0:Math.round(this.parameters.I_concentration*t);for(let o=0;o<e;o++){const s=Math.random()*2*Math.PI,n=50*this.getResponsiveSpeedMultiplier();this.objects.push({id:`S_${o}`,type:"S",unique_name:`S${this.object_counters.S++}`,x:Math.random()*this.parameters.canvas_width,y:Math.random()*this.parameters.canvas_height,vx:Math.cos(s)*n,vy:Math.sin(s)*n,targetSpeed:n,bound:!1})}for(let o=0;o<a;o++){const s=Math.random()*2*Math.PI,n=40*this.getResponsiveSpeedMultiplier();this.objects.push({id:`E_${o}`,type:"E",unique_name:`E${this.object_counters.E++}`,x:Math.random()*this.parameters.canvas_width,y:Math.random()*this.parameters.canvas_height,vx:Math.cos(s)*n,vy:Math.sin(s)*n,targetSpeed:n,bound:!1,substrate_bound:!1,inhibitor_bound:!1})}for(let o=0;o<i;o++){const s=Math.random()*2*Math.PI,n=60*this.getResponsiveSpeedMultiplier();this.objects.push({id:`I_${o}`,type:"I",unique_name:`I${this.object_counters.I++}`,x:Math.random()*this.parameters.canvas_width,y:Math.random()*this.parameters.canvas_height,vx:Math.cos(s)*n,vy:Math.sin(s)*n,targetSpeed:n,bound:!1})}this.clearDataLog(),this.onObjectsInitialized&&this.onObjectsInitialized()}setGlobalSpeedMultiplier(t){this.BASE_SPEED_MULTIPLIER=Math.max(.01,Math.min(t,2)),console.log(`Base speed multiplier set to: ${this.BASE_SPEED_MULTIPLIER} (responsive: ${this.getResponsiveSpeedMultiplier()})`)}isNearby(t,e,a=null){const i=a||this.getResponsiveBindingThreshold(25),o=t.x-e.x,s=t.y-e.y;return Math.sqrt(o*o+s*s)<i}simulateStep(t=null){if(!this.isRunning||this.playbackState.mode!=="live")return;const e=t||this.parameters.time_step;this.simulateStepForPreCalculation(e),this.time-this.lastRecordTime>=.05&&(this.recordState(),this.lastRecordTime=this.time),this.time+=e}simulateStepForPreCalculation(t){const e=this.objects.filter(s=>s.type==="E"),a=this.objects.filter(s=>s.type==="S"&&!s.bound),i=this.objects.filter(s=>s.type==="I"&&!s.bound),o=this.objects.filter(s=>["ES","EI","ESI"].includes(s.type));this.handleComplexReactions(o,t),this.handleEnzymeSubstrateInteractions(e,a,t),this.parameters.inhibitor_type!=="None"&&this.handleEnzymeInhibitorInteractions(e,i,t),this.moveObjects(t)}handleComplexReactions(t,e){t.forEach(a=>{a.type==="ES"?Math.random()<this.parameters.k_off_ES*e?this.dissociateComplex(a,"E","S"):Math.random()<this.parameters.k_cat*e&&this.formProduct(a):a.type==="EI"?Math.random()<this.parameters.k_off_EI*e&&this.dissociateComplex(a,"E","I"):a.type==="ESI"&&(Math.random()<this.parameters.k_off_ES*.5*e?this.dissociateESItoEI(a):Math.random()<this.parameters.k_off_EI*.5*e?this.dissociateESItoES(a):Math.random()<this.parameters.k_cat*.1*e&&this.formProductFromESI(a))})}handleEnzymeSubstrateInteractions(t,e,a){t.forEach(i=>{i.bound||e.forEach(o=>{o.bound||this.isNearby(i,o)&&Math.random()<this.parameters.k_on_ES*a&&this.formComplex(i,o,"ES")})})}handleEnzymeInhibitorInteractions(t,e,a){const i=this.objects.filter(o=>o.type==="ES");e.forEach(o=>{o.bound||(this.parameters.inhibitor_type==="Competitive"?t.forEach(s=>{!s.bound&&this.isNearby(s,o)&&Math.random()<this.parameters.k_on_EI*a&&this.formComplex(s,o,"EI")}):this.parameters.inhibitor_type==="Un-competitive"?i.forEach(s=>{this.isNearby(s,o)&&Math.random()<this.parameters.k_on_EI*a&&this.formESIComplex(s,o)}):this.parameters.inhibitor_type==="Non-competitive"&&(t.forEach(s=>{!s.bound&&this.isNearby(s,o)&&Math.random()<this.parameters.k_on_EI*a&&this.formComplex(s,o,"EI")}),i.forEach(s=>{this.isNearby(s,o)&&Math.random()<this.parameters.k_on_EI*a&&this.formESIComplex(s,o)})))})}formComplex(t,e,a){this.objects=this.objects.filter(r=>r.id!==t.id&&r.id!==e.id);const i=Math.random()*2*Math.PI,n=50*this.getResponsiveSpeedMultiplier()*({ES:.4,EI:.4,ESI:.3}[a]||.4);this.objects.push({id:`${a}_${t.id}_${e.id}`,type:a,unique_name:`${a}${this.object_counters[a]++}`,x:(t.x+e.x)/2,y:(t.y+e.y)/2,vx:Math.cos(i)*n,vy:Math.sin(i)*n,targetSpeed:n,bound:!0,components:[t.id,e.id],component_names:[t.unique_name,e.unique_name]})}formESIComplex(t,e){this.objects=this.objects.filter(o=>o.id!==t.id&&o.id!==e.id);const a=t.components||[t.id.split("_")[1],t.id.split("_")[2]],i=t.component_names||[t.unique_name];this.objects.push({id:`ESI_${t.id}_${e.id}`,type:"ESI",unique_name:`ESI${this.object_counters.ESI++}`,x:(t.x+e.x)/2,y:(t.y+e.y)/2,vx:((t.vx||0)+(e.vx||0))/4,vy:((t.vy||0)+(e.vy||0))/4,bound:!0,components:[...a,e.id],component_names:[...i,e.unique_name]})}dissociateComplex(t,e,a){this.objects=this.objects.filter(h=>h.id!==t.id);const i=Math.random()*2*Math.PI,o=Math.random()*2*Math.PI,s=50*this.getResponsiveSpeedMultiplier(),n={E:.8,S:1,I:1.2,P:.6},r=s*(n[e]||1),l=s*(n[a]||1);this.objects.push({id:`${e}_${Date.now()}_${Math.random()}`,type:e,unique_name:`${e}${this.object_counters[e]++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:Math.cos(i)*r,vy:Math.sin(i)*r,targetSpeed:r,bound:!1}),this.objects.push({id:`${a}_${Date.now()}_${Math.random()}`,type:a,unique_name:`${a}${this.object_counters[a]++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:Math.cos(o)*l,vy:Math.sin(o)*l,targetSpeed:l,bound:!1})}dissociateESItoEI(t){this.objects=this.objects.filter(e=>e.id!==t.id),this.objects.push({id:`EI_${Date.now()}_${Math.random()}`,type:"EI",unique_name:`EI${this.object_counters.EI++}`,x:t.x+(Math.random()-.5)*5,y:t.y+(Math.random()-.5)*5,vx:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),bound:!0,components:["E","I"],component_names:["E","I"]}),this.objects.push({id:`S_${Date.now()}_${Math.random()}`,type:"S",unique_name:`S${this.object_counters.S++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:(Math.random()-.5)*100*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*100*this.getResponsiveSpeedMultiplier(),bound:!1})}dissociateESItoES(t){this.objects=this.objects.filter(e=>e.id!==t.id),this.objects.push({id:`ES_${Date.now()}_${Math.random()}`,type:"ES",unique_name:`ES${this.object_counters.ES++}`,x:t.x+(Math.random()-.5)*5,y:t.y+(Math.random()-.5)*5,vx:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),bound:!0,components:["E","S"],component_names:["E","S"]}),this.objects.push({id:`I_${Date.now()}_${Math.random()}`,type:"I",unique_name:`I${this.object_counters.I++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:(Math.random()-.5)*120*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*120*this.getResponsiveSpeedMultiplier(),bound:!1})}formProduct(t){this.objects=this.objects.filter(s=>s.id!==t.id);const e=Math.random()*2*Math.PI,a=40*this.getResponsiveSpeedMultiplier();this.objects.push({id:`E_${Date.now()}_${Math.random()}`,type:"E",unique_name:`E${this.object_counters.E++}`,x:t.x,y:t.y,vx:Math.cos(e)*a,vy:Math.sin(e)*a,targetSpeed:a,bound:!1});const i=Math.random()*2*Math.PI,o=30*this.getResponsiveSpeedMultiplier();this.objects.push({id:`P_${Date.now()}_${Math.random()}`,type:"P",unique_name:`P${this.object_counters.P++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:Math.cos(i)*o,vy:Math.sin(i)*o,targetSpeed:o,bound:!1})}formProductFromESI(t){this.objects=this.objects.filter(e=>e.id!==t.id),this.objects.push({id:`EI_${Date.now()}_${Math.random()}`,type:"EI",unique_name:`EI${this.object_counters.EI++}`,x:t.x,y:t.y,vx:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*40*this.getResponsiveSpeedMultiplier(),bound:!0,components:["E","I"],component_names:["E","I"]}),this.objects.push({id:`P_${Date.now()}_${Math.random()}`,type:"P",unique_name:`P${this.object_counters.P++}`,x:t.x+(Math.random()-.5)*10,y:t.y+(Math.random()-.5)*10,vx:(Math.random()-.5)*60*this.getResponsiveSpeedMultiplier(),vy:(Math.random()-.5)*60*this.getResponsiveSpeedMultiplier(),bound:!1})}moveObjects(t){this.objects.forEach(e=>{if(!e.bound||["ES","EI","ESI"].includes(e.type)){if(!e.vx||!e.vy||!e.targetSpeed){const l=Math.random()*2*Math.PI,h=50*this.getResponsiveSpeedMultiplier(),m={S:1,E:.8,I:1.2,P:.6,ES:.4,EI:.4,ESI:.3};e.targetSpeed=h*(m[e.type]||1),e.vx=Math.cos(l)*e.targetSpeed,e.vy=Math.sin(l)*e.targetSpeed}const a=Math.sqrt(e.vx*e.vx+e.vy*e.vy);a>0&&(e.vx=e.vx/a*e.targetSpeed,e.vy=e.vy/a*e.targetSpeed),e.x+=e.vx*t,e.y+=e.vy*t;const i=this.parameters.canvas_width,o=this.parameters.canvas_height;let s;i>=800?s=1:i>=600?s=.6:s=.3;const r=Math.max(5,20*s);(e.x<=r||e.x>=i-r)&&(e.vx=-e.vx,e.x=Math.max(r,Math.min(i-r,e.x))),(e.y<=r||e.y>=o-r)&&(e.vy=-e.vy,e.y=Math.max(r,Math.min(o-r,e.y)))}})}recordState(){this.objects.forEach(e=>{this.dataLog.molecularData.push([this.time,[e.x,e.y,e.unique_name||e.type]])});const t=this.getSummary();this.dataLog.summary.push([this.time,t]),this.dataLog.time.push(this.time)}clearDataLog(){this.dataLog={time:[],molecularData:[],summary:[]}}start(){this.isRunning=!0,this.playbackState.mode==="live"&&this.objects.length===0&&this.initializeObjects()}pause(){this.isRunning=!1,this.pausePlayback()}reset(){this.time=0,this.lastRecordTime=0,this.isRunning=!1,this.playbackState.currentTime=0,this.playbackState.isPlaying=!1,this.isPreCalculating=!1,this.preCalculatedData={timePoints:[],particleData:[],summaryData:[],averagedData:[],isGenerated:!1,totalDuration:this.parameters.timeframe},this.clearDataLog(),this.initializeObjects()}getCurrentObjects(){return this.playbackState.mode==="playback"?this.getParticlesAtTime(this.playbackState.currentTime):this.objects}getSummary(){const t={},e=this.getCurrentObjects();return["E","S","I","P","ES","EI","ESI"].forEach(a=>{t[a]=e.filter(i=>i.type===a).length}),t}getFinalVelocity(){return!this.preCalculatedData.isGenerated||this.preCalculatedData.summaryData.length===0?0:(this.preCalculatedData.summaryData[this.preCalculatedData.summaryData.length-1][1].P||0)*.1/this.parameters.timeframe}getMemoryStats(){const t={objectCount:this.objects.length,timePointsCount:this.preCalculatedData.timePoints.length,particleDataCount:this.preCalculatedData.particleData.length,summaryDataCount:this.preCalculatedData.summaryData.length,averagedDataCount:this.preCalculatedData.averagedData?this.preCalculatedData.averagedData.length:0,dataLogTime:this.dataLog.time.length,dataLogMolecular:this.dataLog.molecularData.length,dataLogSummary:this.dataLog.summary.length,isPreCalculating:this.isPreCalculating,isGenerated:this.preCalculatedData.isGenerated,hasIndividualRuns:this.preCalculatedData.hasOwnProperty("individualRuns")},e=(t.particleDataCount*100+t.summaryDataCount*50+t.averagedDataCount*50+t.dataLogMolecular*50)/1024/1024;return t.estimatedMemoryMB=e.toFixed(2),t}calculateVelocityOnly(){const t=this.time,e=[...this.objects];for(this.time=0,this.initializeObjects();this.time<this.parameters.timeframe;)this.simulateStepForPreCalculation(this.parameters.time_step),this.time+=this.parameters.time_step;const i=this.objects.filter(o=>o.type==="P").length*.1/this.parameters.timeframe;return this.time=t,this.objects=e,i}exportToCSV(){if(this.preCalculatedData.isGenerated){let e=`time(ms),x,y,object_name
`;return this.preCalculatedData.particleData.forEach(([a,i])=>{i.forEach(o=>{e+=`${a.toFixed(4)},${o.x.toFixed(2)},${o.y.toFixed(2)},${o.unique_name}
`})}),e}let t=`time(ms),x,y,object_name
`;return this.dataLog.molecularData.forEach(e=>{const a=e[0].toFixed(4),i=e[1][0].toFixed(2),o=e[1][1].toFixed(2),s=e[1][2];t+=`${a},${i},${o},${s}
`}),t}exportSummaryToCSV(){if(this.preCalculatedData.isGenerated){let e=`time(ms),E,S,I,P,ES,EI,ESI
`;return this.preCalculatedData.summaryData.forEach(([a,i])=>{const o=[a.toFixed(4),i.E||0,i.S||0,i.I||0,i.P||0,i.ES||0,i.EI||0,i.ESI||0];e+=o.join(",")+`
`}),e}let t=`time(ms),E,S,I,P,ES,EI,ESI
`;return this.dataLog.summary.forEach(([e,a])=>{const i=[e.toFixed(4),a.E||0,a.S||0,a.I||0,a.P||0,a.ES||0,a.EI||0,a.ESI||0];t+=i.join(",")+`
`}),t}}class St{constructor(t,e=null){this.canvas=t,this.ctx=t?t.getContext("2d"):null,this.animationId=null,this.particleSimulator=null,this.lastTime=performance.now(),this.onResizeComplete=e,this.lastViewSwitchTime=null,this.resizeObserver=null,this.setupResizeObserver(),this.canvas&&this.setupCanvas()}setupResizeObserver(){this.canvas&&window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(t=>{for(let e of t)clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{var s;this.handleResize();const a=performance.now(),i=this.lastViewSwitchTime?a-this.lastViewSwitchTime:1/0,o=!((s=window.appState)!=null&&s.isSwitchingViews)&&i>1e3;this.onResizeComplete&&o?(console.log("MolecularRenderer: Triggering reset callback for genuine resize"),this.onResizeComplete()):o||console.log("MolecularRenderer: Skipping reset callback - view switch in progress or recent")},200)}),this.resizeObserver.observe(this.canvas))}setupCanvas(){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect(),e=Math.max(t.width||800,300),a=Math.max(t.height||400,200);this.canvas.width=e*window.devicePixelRatio,this.canvas.height=a*window.devicePixelRatio,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio),console.log(`Molecular canvas resized: ${e}x${a} (ratio: ${window.devicePixelRatio})`),this.updateSimulationBounds(e,a)}updateSimulationBounds(t,e){this.particleSimulator&&(this.particleSimulator.setParameters({canvas_width:t,canvas_height:e}),this.constrainParticlesToBounds(t,e))}constrainParticlesToBounds(t,e){var r;if(!this.particleSimulator)return;if((r=window.appState)!=null&&r.isSwitchingViews){console.log("Skipping particle constraint during view switch");return}let a;t>=800?a=1:t>=600?a=.6:a=.3;const o=Math.max(5,20*a),s=this.particleSimulator.getCurrentObjects();let n=0;if(s.length>500){this.constrainParticlesBatched(s,t,e,o);return}s.forEach(l=>{let h=!1;l.x<o?(l.x=o,h=!0):l.x>t-o&&(l.x=t-o,h=!0),l.y<o?(l.y=o,h=!0):l.y>e-o&&(l.y=e-o,h=!0),h&&n++}),n>0&&console.log(`Constrained ${n} particles to new canvas bounds: ${t}x${e} (boundary: ${o.toFixed(1)}px)`)}constrainParticlesBatched(t,e,a,i){let s=0,n=0;const r=()=>{const l=Math.min(s+100,t.length);for(let h=s;h<l;h++){const m=t[h];let f=!1;m.x<i?(m.x=i,f=!0):m.x>e-i&&(m.x=e-i,f=!0),m.y<i?(m.y=i,f=!0):m.y>a-i&&(m.y=a-i,f=!0),f&&n++}s=l,s<t.length?requestAnimationFrame(r):n>0&&console.log(`Batched constraint: ${n} particles constrained to bounds: ${e}x${a}`)};requestAnimationFrame(r)}drawMolecule(t,e,a,i){const o={E:"#3498db",S:"#2ecc71",P:"#f39c12",I:"#e74c3c",ES:"#9b59b6",EI:"#8b0000",ESI:"#663399"},s={E:15,S:10,P:10,I:10,ES:18,EI:18,ESI:20},r=this.canvas.getBoundingClientRect().width||800;let l;r>=800?l=1:r>=600?l=.6:l=.3;const h=o[a]||"#ffffff",m=s[a]||10,f=Math.max(5,m*l);this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,f,0,Math.PI*2),this.ctx.fillStyle=h,this.ctx.fill();const p=this.ctx.createRadialGradient(t-f/3,e-f/3,0,t,e,f);p.addColorStop(0,"rgba(255,255,255,0.6)"),p.addColorStop(1,h),this.ctx.fillStyle=p,this.ctx.fill(),this.ctx.strokeStyle="rgba(255,255,255,0.8)",this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.fillStyle="#000000",this.ctx.font=`${Math.max(10,f*.6)}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i||a,t,e),this.ctx.restore()}render(t,e){if(!t)return;const a=(e-this.lastTime)/1e3;this.lastTime=e,t.playbackState.mode==="playback"&&t.updatePlayback(a),this.drawBackground(),t.getCurrentObjects().forEach(o=>{this.drawMolecule(o.x,o.y,o.type,o.type)}),this.drawVelocityProfileChart()}drawSimulationInfo(t){const e=this.canvas.getBoundingClientRect(),a=t.getSummary();this.ctx.save();const i=e.width<768,o=i?Math.min(250,e.width-20):280,s=i?140:160,n=i?12:14,r=i?10:12,l=10,h=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(l,h,o,s),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=1,this.ctx.strokeRect(l,h,o,s),this.ctx.fillStyle="#ffffff",this.ctx.font=`bold ${n}px Arial`,this.ctx.textAlign="left";let m=h+20;this.ctx.fillStyle="#3c78d8",this.ctx.fillText("📺 SIMULATION",l+5,m),m+=i?16:20,this.ctx.fillStyle="#ffffff",this.ctx.font=`bold ${r}px Arial`;const f=t.playbackState.currentTime,p=t.preCalculatedData.totalDuration,u=t.playbackState.isPlaying,y=i?`${Math.round(f)}ms/${Math.round(p)}ms`:`Time: ${Math.round(f)}ms / ${Math.round(p)}ms`;this.ctx.fillText(y,l+5,m),m+=i?14:18;const b=i?`${u?"▶️":"⏸️"}`:`${u?"▶️ Playing":"⏸️ Paused"}`;this.ctx.fillText(b,l+5,m),m+=i?16:20,this.ctx.fillText("Molecules:",l+5,m),m+=i?14:18;const x={E:"#3498db",S:"#2ecc71",P:"#f39c12",I:"#e74c3c",ES:"#9b59b6",EI:"#8b0000",ESI:"#993370"};if(i){const S=Object.entries(a).filter(([F,V])=>V>0),P=3;let z=l+5;S.forEach(([F,V],A)=>{A>0&&A%P===0&&(z=l+5,m+=16),this.ctx.fillStyle=x[F]||"#ffffff",this.ctx.beginPath(),this.ctx.arc(z+8,m-3,4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.font=`${r-1}px Arial`,this.ctx.fillText(`${F}:${V}`,z+15,m),z+=75})}else Object.entries(a).forEach(([S,P])=>{P>0&&(this.ctx.fillStyle=x[S]||"#ffffff",this.ctx.beginPath(),this.ctx.arc(l+15,m-4,6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.fillText(`${S}: ${P}`,l+30,m),m+=16)});this.ctx.restore()}drawBackground(){const t=this.canvas.getBoundingClientRect();this.ctx.clearRect(0,0,t.width,t.height);const e=this.ctx.createRadialGradient(t.width/2,t.height/2,0,t.width/2,t.height/2,t.width/2);e.addColorStop(0,"rgba(236, 240, 241, 1)"),e.addColorStop(1,"rgba(189, 195, 199, 1)"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t.width,t.height),this.ctx.strokeStyle="rgba(189, 195, 199, 0.3)",this.ctx.lineWidth=1;for(let a=0;a<t.width;a+=50)this.ctx.beginPath(),this.ctx.moveTo(a,0),this.ctx.lineTo(a,t.height),this.ctx.stroke();for(let a=0;a<t.height;a+=50)this.ctx.beginPath(),this.ctx.moveTo(0,a),this.ctx.lineTo(t.width,a),this.ctx.stroke()}startAnimation(t){this.particleSimulator=t;const e=a=>{this.render(t,a),window.updatePlaybackControlsState&&window.updatePlaybackControlsState(),window.updateParameterDisplay&&window.updateParameterDisplay(),this.animationId=requestAnimationFrame(e)};this.lastTime=performance.now(),this.animationId=requestAnimationFrame(e)}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.particleSimulator=null}renderSingleFrame(t){if(!t){console.log("No particle simulator provided to renderSingleFrame");return}this.particleSimulator=t,this.drawBackground();const e=t.getCurrentObjects();console.log("Rendering single frame with",e.length,"particles"),e.forEach(a=>{this.drawMolecule(a.x,a.y,a.type,a.type)})}drawInitialStateInfo(t){const e=this.canvas.getBoundingClientRect(),a=t.getSummary();this.ctx.save();const i=e.width<768,o=i?Math.min(200,e.width-20):220,s=i?100:120,n=i?11:13,r=10,l=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(r,l,o,s),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=1,this.ctx.strokeRect(r,l,o,s),this.ctx.fillStyle="#3c78d8",this.ctx.font=`bold ${n}px Arial`,this.ctx.textAlign="left",this.ctx.fillText("⚡ INITIAL STATE",r+5,l+18),this.ctx.fillStyle="#ffffff",this.ctx.font=`${n-1}px Arial`,this.ctx.fillText("Ready to simulate:",r+5,l+35);const h={E:"#3498db",S:"#2ecc71",P:"#f39c12",I:"#e74c3c",ES:"#9b59b6",EI:"#8b0000",ESI:"#993370"};let m=l+50;Object.entries(a).filter(([p,u])=>u>0).slice(0,4).forEach(([p,u],y)=>{y%2===0&&y>0&&(m+=15);const b=r+5+y%2*90;this.ctx.fillStyle=h[p]||"#ffffff",this.ctx.beginPath(),this.ctx.arc(b+8,m-3,4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.fillText(`${p}:${u}`,b+15,m)}),this.ctx.restore(),this.drawVelocityProfileChart()}drawVelocityProfileChart(){if(!window.velocityProfileData||window.velocityProfileData.length===0||!window.velocityProfileChartVisible)return;console.log("Rendering velocity chart with",window.velocityProfileData.length,"data points");const t=window.velocityProfileData,e=this.canvas.getBoundingClientRect();this.ctx.save();const a=e.width<768,i=a?250:320,o=a?160:200,s=a?10:12,n=20,r=this.canvas.height-o-20,l=n+40,h=r+20,m=i-60,f=o-60;this.ctx.fillStyle="rgba(255, 255, 255, 0.95)",this.ctx.fillRect(n,r,i,o),this.ctx.strokeStyle="#333333",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,i,o),this.ctx.fillStyle="#333333",this.ctx.font=`bold ${s+2}px Arial`,this.ctx.textAlign="center",this.ctx.fillText("Velocity vs Substrate",n+i/2,r+15);const p=Math.max(...t.map(x=>x.substrateConcentration)),u=Math.max(...t.map(x=>x.velocity)),y=Math.min(...t.map(x=>x.velocity));this.ctx.strokeStyle="#666666",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(l,h+f),this.ctx.lineTo(l+m,h+f),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(l,h),this.ctx.lineTo(l,h+f),this.ctx.stroke(),this.ctx.setLineDash([1,1]),this.ctx.strokeStyle="#cccccc";for(let x=1;x<5;x++){const S=l+m*x/5;this.ctx.beginPath(),this.ctx.moveTo(S,h),this.ctx.lineTo(S,h+f),this.ctx.stroke()}for(let x=1;x<4;x++){const S=h+f*x/4;this.ctx.beginPath(),this.ctx.moveTo(l,S),this.ctx.lineTo(l+m,S),this.ctx.stroke()}this.ctx.setLineDash([]),this.ctx.strokeStyle="#e74c3c",this.ctx.lineWidth=2,this.ctx.beginPath();let b=!0;t.forEach(x=>{const S=l+x.substrateConcentration/p*m,P=h+f-(x.velocity-y)/(u-y)*f;b?(this.ctx.moveTo(S,P),b=!1):this.ctx.lineTo(S,P)}),this.ctx.stroke(),this.ctx.fillStyle="#c0392b",t.forEach(x=>{const S=l+x.substrateConcentration/p*m,P=h+f-(x.velocity-y)/(u-y)*f;this.ctx.beginPath(),this.ctx.arc(S,P,2,0,Math.PI*2),this.ctx.fill()}),this.ctx.fillStyle="#333333",this.ctx.font=`${s}px Arial`,this.ctx.textAlign="center",this.ctx.fillText("Substrate (mM)",l+m/2,r+o-5),this.ctx.save(),this.ctx.translate(n+12,h+f/2),this.ctx.rotate(-Math.PI/2),this.ctx.fillText("Velocity (mM·ms⁻¹)",0,0),this.ctx.restore(),this.ctx.font=`${s-1}px Arial`,this.ctx.textAlign="center";for(let x=0;x<=5;x++){const S=p*x/5,P=l+m*x/5;this.ctx.fillText(S.toFixed(0),P,h+f+12)}this.ctx.textAlign="right";for(let x=0;x<=4;x++){const S=y+(u-y)*(1-x/4),P=h+f*x/4+3;this.ctx.fillText(S.toFixed(3),l-5,P)}this.ctx.restore()}exportVelocityChartAsPNG(t="velocity_profile_chart.png"){if(!window.velocityProfileData||window.velocityProfileData.length===0){console.warn("No velocity profile data available for PNG export");return}const e=window.velocityProfileData,a=document.createElement("canvas"),i=a.getContext("2d"),o=800,s=600;a.width=o,a.height=s;const n=80,r=60,l=o-120,h=s-120;i.fillStyle="#ffffff",i.fillRect(0,0,o,s),i.fillStyle="#333333",i.font="bold 24px Arial",i.textAlign="center",i.fillText("Velocity vs Substrate Concentration",o/2,35);const m=Math.max(...e.map(u=>u.substrateConcentration)),f=Math.max(...e.map(u=>u.velocity)),p=0;i.strokeStyle="#333333",i.lineWidth=2,i.beginPath(),i.moveTo(n,r),i.lineTo(n,r+h),i.moveTo(n,r+h),i.lineTo(n+l,r+h),i.stroke(),i.strokeStyle="#e0e0e0",i.lineWidth=1;for(let u=1;u<=5;u++){const y=n+l*u/5;i.beginPath(),i.moveTo(y,r),i.lineTo(y,r+h),i.stroke()}for(let u=1;u<=4;u++){const y=r+h*u/4;i.beginPath(),i.moveTo(n,y),i.lineTo(n+l,y),i.stroke()}i.strokeStyle="#e74c3c",i.fillStyle="#e74c3c",i.lineWidth=3,i.beginPath(),e.forEach((u,y)=>{const b=n+u.substrateConcentration/m*l,x=r+h-(u.velocity-p)/(f-p)*h;y===0?i.moveTo(b,x):i.lineTo(b,x)}),i.stroke(),e.forEach(u=>{const y=n+u.substrateConcentration/m*l,b=r+h-(u.velocity-p)/(f-p)*h;i.beginPath(),i.arc(y,b,4,0,Math.PI*2),i.fill()}),i.fillStyle="#333333",i.font="18px Arial",i.textAlign="center",i.fillText("Substrate Concentration (mM)",n+l/2,s-15),i.save(),i.translate(25,r+h/2),i.rotate(-Math.PI/2),i.fillText("Velocity (mM·ms⁻¹)",0,0),i.restore(),i.font="14px Arial",i.textAlign="center";for(let u=0;u<=5;u++){const y=m*u/5,b=n+l*u/5;i.fillText(y.toFixed(0),b,r+h+20)}i.textAlign="right";for(let u=0;u<=4;u++){const y=p+(f-p)*(1-u/4),b=r+h*u/4+6;i.fillText(y.toFixed(3),n-10,b)}try{a.toBlob(u=>{if(u){const y=URL.createObjectURL(u),b=document.createElement("a");b.href=y,b.download=t,b.style.display="none",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(y),console.log(`Velocity profile chart exported as ${t}`)}else console.error("Failed to create blob for PNG export")},"image/png")}catch(u){console.error("Error exporting velocity chart as PNG:",u)}}reset(){if(this.canvas){const t=this.canvas.getBoundingClientRect();this.ctx.clearRect(0,0,t.width,t.height),this.drawBackground()}}handleResize(){this.setupCanvas()}notifyViewSwitch(){this.lastViewSwitchTime=performance.now(),console.log("MolecularRenderer: View switch notification received")}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),clearTimeout(this.resizeTimeout)}}class vt{constructor(t,e=null){this.canvas=t,this.ctx=t?t.getContext("2d"):null,this.onResizeComplete=e,this.animationId=null,this.lastTime=performance.now(),this.lastViewSwitchTime=null,this.resizeObserver=null,this.setupResizeObserver(),this.canvas&&this.setupCanvas(),this.config={colors:{substrate:"#2ecc71",product:"#f1c40f",background:"#ffffff",gridLines:"#ecf0f1",axisColor:"#2c3e50",textColor:"#2c3e50"},plot:{lineWidth:3,glowWidth:8,margins:{top:40,right:60,bottom:100,left:80}}},this.plotBounds={xMin:0,xMax:500,yMin:0,yMax:10},this.timePoints=[],this.substrateData=[],this.productData=[],this.currentTime=0,this.simulationData=null,this.setupCanvas()}setupCanvas(){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect(),e=Math.max(t.width||800,300),a=Math.max(t.height||400,200);this.canvas.width=e*window.devicePixelRatio,this.canvas.height=a*window.devicePixelRatio,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio),console.log(`Plot canvas resized: ${e}x${a} (ratio: ${window.devicePixelRatio})`)}setupResizeObserver(){this.canvas&&window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(t=>{for(let e of t)clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{var s;this.handleResize();const a=performance.now(),i=this.lastViewSwitchTime?a-this.lastViewSwitchTime:1/0,o=!((s=window.appState)!=null&&s.isSwitchingViews)&&i>1e3;this.onResizeComplete&&o?(console.log("PlotRenderer: Triggering reset callback for genuine resize"),this.onResizeComplete()):o||console.log("PlotRenderer: Skipping reset callback - view switch in progress or recent")},200)}),this.resizeObserver.observe(this.canvas))}loadSimulationData(t){if(!t)return console.warn("PlotRenderer: No particle simulator provided"),!1;if(!t.preCalculatedData.isGenerated)return console.log("PlotRenderer: Pre-calculated data not ready yet, will retry when available"),this.timePoints=[],this.substrateData=[],this.productData=[],this.simulationData={loaded:!1},!1;const e=t.preCalculatedData.averagedData||t.preCalculatedData.summaryData;if(!e||e.length===0)return console.warn("PlotRenderer: No summary data available"),!1;const a=t.preCalculatedData.individualRuns?t.preCalculatedData.individualRuns.length:1;console.log(`PlotRenderer: Using averaged data from ${a} runs for smooth plotting`);const i=10;this.timePoints=[],this.substrateData=[],this.productData=[];for(const[s,n]of e)if(s<=500){const r=n.S||0,l=n.ES||0,h=n.ESI||0,m=n.P||0,f=(r+l+h)/i,p=m/i;this.timePoints.push(s),this.substrateData.push(f),this.productData.push(p)}const o=Math.max(...this.substrateData,...this.productData);return this.plotBounds.yMax=Math.max(o*1.1,1),this.simulationData={loaded:!0},console.log(`PlotRenderer: Loaded ${this.timePoints.length} data points for time-course plot`),!0}updateVelocityPoints(t,e){if(!isFinite(t)||!isFinite(e)||t<0||e<0)return;const a=this.velocityPoints.find(i=>Math.abs(i.substrate-t)<.1);a?(a.velocity=(a.velocity+e)/2,a.count++):this.velocityPoints.push({substrate:t,velocity:e,count:1}),this.velocityPoints.sort((i,o)=>i.substrate-o.substrate),this.velocityPoints.length>100&&(this.velocityPoints=this.velocityPoints.slice(-100))}dataToScreen(t,e){const a=this.canvas.getBoundingClientRect(),i=a.width-this.config.plots.margins.left-this.config.plots.margins.right,o=a.height-this.config.plots.margins.top-this.config.plots.margins.bottom,s=this.config.plots.margins.left+(t-this.plotBounds.xMin)/(this.plotBounds.xMax-this.plotBounds.xMin)*i,n=this.config.plots.margins.top+o-(e-this.plotBounds.yMin)/(this.plotBounds.yMax-this.plotBounds.yMin)*o;return{x:s,y:n}}drawAxes(t,e){const a=this.ctx,i=this.canvas.getBoundingClientRect();a.strokeStyle=this.config.colors.axisColor,a.lineWidth=2,a.font="12px Arial",a.fillStyle=this.config.colors.textColor;const o=this.config.plots.margins.left,s=i.width-this.config.plots.margins.right,n=this.config.plots.margins.top,r=i.height-this.config.plots.margins.bottom;a.beginPath(),a.moveTo(o,r),a.lineTo(s,r),a.stroke(),a.beginPath(),a.moveTo(o,n),a.lineTo(o,r),a.stroke(),this.drawGrid(),this.drawAxisLabels(t,e)}drawGrid(){const t=this.ctx,e=this.canvas.getBoundingClientRect();t.strokeStyle=this.config.colors.gridLines,t.lineWidth=1,t.globalAlpha=this.config.plots.gridAlpha;const a=this.config.plots.margins.left,i=e.width-this.config.plots.margins.right,o=this.config.plots.margins.top,s=e.height-this.config.plots.margins.bottom,n=10;for(let l=0;l<=n;l++){const h=a+(i-a)*l/n;t.beginPath(),t.moveTo(h,o),t.lineTo(h,s),t.stroke();const m=this.plotBounds.xMin+(this.plotBounds.xMax-this.plotBounds.xMin)*l/n;t.fillStyle=this.config.colors.textColor,t.textAlign="center",t.fillText(m.toFixed(1),h,s+20)}const r=8;for(let l=0;l<=r;l++){const h=o+(s-o)*l/r;t.beginPath(),t.moveTo(a,h),t.lineTo(i,h),t.stroke();const m=this.plotBounds.yMax-(this.plotBounds.yMax-this.plotBounds.yMin)*l/r;t.fillStyle=this.config.colors.textColor,t.textAlign="right",t.fillText(m.toFixed(1),a-10,h+4)}t.globalAlpha=1}drawAxisLabels(t,e){const a=this.ctx,i=this.canvas.getBoundingClientRect();a.font="bold 14px Arial",a.fillStyle=this.config.colors.textColor,a.textAlign="center",a.fillText(t,i.width/2,i.height-10),a.save(),a.translate(15,i.height/2),a.rotate(-Math.PI/2),a.fillText(e,0,0),a.restore()}drawLineSeries(t,e,a,i,o){if(t.length<2)return;const s=this.ctx;s.strokeStyle=i,s.lineWidth=this.config.plots.lineWidth,s.globalAlpha=.8,s.beginPath();let n=!0;t.forEach(r=>{const l=this.dataToScreen(r[e],r[a]);n?(s.moveTo(l.x,l.y),n=!1):s.lineTo(l.x,l.y)}),s.stroke(),s.globalAlpha=1}drawScatterPoints(t,e,a,i){const o=this.ctx;o.fillStyle=i,o.globalAlpha=.7,t.forEach(s=>{const n=this.dataToScreen(s[e],s[a]);o.beginPath(),o.arc(n.x,n.y,this.config.plots.pointSize,0,2*Math.PI),o.fill()}),o.globalAlpha=1}drawTheoreticalCurve(t){const e=this.ctx,a=[];for(let o=this.plotBounds.xMin;o<=this.plotBounds.xMax;o+=.1){const s={...t.state,substrate:o},n={...t,state:s},r=n.calculateVelocity.call(n);a.push({substrate:o,velocity:r})}e.strokeStyle=this.config.colors.theoretical,e.lineWidth=1,e.globalAlpha=.5,e.setLineDash([5,5]),e.beginPath();let i=!0;a.forEach(o=>{const s=this.dataToScreen(o.substrate,o.velocity);i?(e.moveTo(s.x,s.y),i=!1):e.lineTo(s.x,s.y)}),e.stroke(),e.setLineDash([]),e.globalAlpha=1}drawLegend(t){const e=this.ctx,i=this.canvas.getBoundingClientRect().width-this.config.plots.margins.right-150,o=this.config.plots.margins.top+10,s=20;e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(i-10,o-5,140,t.length*s+10),e.strokeStyle=this.config.colors.gridLines,e.strokeRect(i-10,o-5,140,t.length*s+10),e.font="12px Arial",t.forEach((n,r)=>{const l=o+r*s;e.fillStyle=n.color,e.fillRect(i,l-6,15,12),e.fillStyle=this.config.colors.textColor,e.fillText(n.label,i+20,l+4)})}drawProgressPlot(t){this.plotBounds={xMin:0,xMax:Math.max(60,t.time+5),yMin:0,yMax:Math.max(10,Math.max(t.state.substrate*1.2,t.state.product*1.2))},this.drawAxes("Time (ms)","Concentration (mM)"),this.dataHistory.length>1&&(this.drawLineSeries(this.dataHistory,"time","substrate",this.config.colors.substrate,"Substrate"),this.drawLineSeries(this.dataHistory,"time","product",this.config.colors.product,"Product"),this.drawLineSeries(this.dataHistory,"time","enzymeSubstrate",this.config.colors.enzymeSubstrate,"ES Complex")),this.drawLegend([{color:this.config.colors.substrate,label:"Substrate [S]"},{color:this.config.colors.product,label:"Product [P]"},{color:this.config.colors.enzymeSubstrate,label:"ES Complex"}])}drawVelocityPlot(t){const e=t.getApparentVmax(),a=140;this.plotBounds={xMin:0,xMax:a,yMin:0,yMax:e*1.1},this.drawAxes("Substrate Concentration [S] (mM)","Velocity (μM·ms⁻¹)"),this.drawTheoreticalCurve(t),this.velocityPoints.length>0&&this.drawScatterPoints(this.velocityPoints,"substrate","velocity",this.config.colors.velocity);const i=t.state.substrate,o=t.calculateVelocity(),s=this.dataToScreen(i,o);this.ctx.fillStyle=this.config.colors.velocity,this.ctx.globalAlpha=1,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,this.config.plots.pointSize*1.5,0,2*Math.PI),this.ctx.fill(),this.drawLegend([{color:this.config.colors.theoretical,label:"Theoretical Curve"},{color:this.config.colors.velocity,label:"Data Points"}])}render(t,e=performance.now()){if(!this.canvas||!this.ctx||!t)return;const a=(e-this.lastTime)/1e3;this.lastTime=e,t.playbackState.mode==="playback"&&t.updatePlayback(a);const i=this.canvas.getBoundingClientRect();if(this.ctx.fillStyle=this.config.colors.background,this.ctx.fillRect(0,0,i.width,i.height),(!this.simulationData||!this.simulationData.loaded)&&!this.loadSimulationData(t)){this.drawEmptyPlot();return}this.currentTime=t.playbackState.currentTime||0,this.drawTimeCoursePlot()}drawEmptyPlot(){const t=this.canvas.getBoundingClientRect(),e=this.getResponsiveMargins(),a=t.width-e.left-e.right,i=t.height-e.top-e.bottom;this.drawGrid(a,i,e),this.drawAxes(a,i,e),this.ctx.save(),this.ctx.fillStyle=this.config.colors.textColor,this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Loading simulation data...",e.left+a/2,e.top+i/2),this.ctx.restore(),this.drawLegend(e)}drawTimeCoursePlot(){if(this.timePoints.length===0)return;const t=this.canvas.getBoundingClientRect(),e=this.getResponsiveMargins(),a=t.width-e.left-e.right,i=t.height-e.top-e.bottom;this.drawGrid(a,i,e),this.drawAxes(a,i,e);const{currentTimeData:o,currentSubstrateData:s,currentProductData:n}=this.getProgressiveData();o.length>0&&(this.drawGlowingCurve(o,s,this.config.colors.substrate,"Substrate"),this.drawGlowingCurve(o,n,this.config.colors.product,"Product")),this.drawLegend(e)}getResponsiveMargins(){const t=this.config.plot.margins;return window.innerWidth<=768?{...t,bottom:80}:{...t,bottom:100}}drawGlowingCurve(t,e,a,i){if(t.length<2)return;const o=this.canvas.getBoundingClientRect(),s=this.config.plot.margins,n=o.width-s.left-s.right,r=o.height-s.top-s.bottom;this.ctx.save(),this.ctx.globalCompositeOperation="screen",this.ctx.strokeStyle=a,this.ctx.lineWidth=this.config.plot.glowWidth,this.ctx.shadowColor=a,this.ctx.shadowBlur=15,this.ctx.beginPath();let l=!0;for(let h=0;h<t.length;h++){const m=s.left+t[h]/this.plotBounds.xMax*n,f=s.top+r-e[h]/this.plotBounds.yMax*r;if(l)this.ctx.moveTo(m,f),l=!1;else{const p=s.left+t[h-1]/this.plotBounds.xMax*n,u=s.top+r-e[h-1]/this.plotBounds.yMax*r,y=(p+m)/2,b=(u+f)/2;this.ctx.quadraticCurveTo(y,b,m,f)}}this.ctx.stroke(),this.ctx.globalCompositeOperation="source-over",this.ctx.lineWidth=this.config.plot.lineWidth,this.ctx.shadowBlur=0,this.ctx.beginPath(),l=!0;for(let h=0;h<t.length;h++){const m=s.left+t[h]/this.plotBounds.xMax*n,f=s.top+r-e[h]/this.plotBounds.yMax*r;if(l)this.ctx.moveTo(m,f),l=!1;else{const p=s.left+t[h-1]/this.plotBounds.xMax*n,u=s.top+r-e[h-1]/this.plotBounds.yMax*r,y=(p+m)/2,b=(u+f)/2;this.ctx.quadraticCurveTo(y,b,m,f)}}this.ctx.stroke(),this.ctx.restore()}getProgressiveData(){if(this.currentTime<=0)return{currentTimeData:[],currentSubstrateData:[],currentProductData:[]};const t=[],e=[],a=[];for(let i=0;i<this.timePoints.length&&this.timePoints[i]<=this.currentTime;i++)t.push(this.timePoints[i]),e.push(this.substrateData[i]),a.push(this.productData[i]);return{currentTimeData:t,currentSubstrateData:e,currentProductData:a}}startAnimation(t){this.particleSimulator=t;const e=a=>{this.render(t,a),window.updatePlaybackControlsState&&window.updatePlaybackControlsState(),window.updateParameterDisplay&&window.updateParameterDisplay(),this.animationId=requestAnimationFrame(e)};this.lastTime=performance.now(),this.animationId=requestAnimationFrame(e)}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}reset(){this.timePoints=[],this.substrateData=[],this.productData=[],this.currentTime=0,this.simulationData=null}drawGrid(t,e,a){this.ctx.save(),this.ctx.strokeStyle=this.config.colors.gridLines,this.ctx.lineWidth=1,this.ctx.globalAlpha=.5;const i=5;for(let s=0;s<=i;s++){const n=a.left+s/i*t;this.ctx.beginPath(),this.ctx.moveTo(n,a.top),this.ctx.lineTo(n,a.top+e),this.ctx.stroke()}const o=5;for(let s=0;s<=o;s++){const n=a.top+s/o*e;this.ctx.beginPath(),this.ctx.moveTo(a.left,n),this.ctx.lineTo(a.left+t,n),this.ctx.stroke()}this.ctx.restore()}drawAxes(t,e,a){this.ctx.save(),this.ctx.strokeStyle=this.config.colors.axisColor,this.ctx.fillStyle=this.config.colors.textColor,this.ctx.lineWidth=2,this.ctx.font="12px Arial",this.ctx.beginPath(),this.ctx.moveTo(a.left,a.top+e),this.ctx.lineTo(a.left+t,a.top+e),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(a.left,a.top),this.ctx.lineTo(a.left,a.top+e),this.ctx.stroke(),this.ctx.textAlign="center",this.ctx.textBaseline="top";const i=5;for(let s=0;s<=i;s++){const n=a.left+s/i*t,r=s/i*this.plotBounds.xMax;this.ctx.fillText(`${r.toFixed(0)}`,n,a.top+e+10)}this.ctx.textAlign="right",this.ctx.textBaseline="middle";const o=5;for(let s=0;s<=o;s++){const n=a.top+e-s/o*e,r=s/o*this.plotBounds.yMax;this.ctx.fillText(`${r.toFixed(1)}`,a.left-10,n)}this.ctx.font="bold 14px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText("Time (ms)",a.left+t/2,a.top+e+50),this.ctx.save(),this.ctx.translate(15,a.top+e/2),this.ctx.rotate(-Math.PI/2),this.ctx.fillText("Concentration (mM)",0,0),this.ctx.restore(),this.ctx.restore()}drawLegend(t){this.ctx.save(),this.ctx.font="12px Arial",this.ctx.textBaseline="middle";const e=[{color:this.config.colors.substrate,label:"Substrate"},{color:this.config.colors.product,label:"Product"}];let a=t.top+20;e.forEach((i,o)=>{const s=t.left+20;this.ctx.strokeStyle=i.color,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(s,a),this.ctx.lineTo(s+20,a),this.ctx.stroke(),this.ctx.fillStyle=this.config.colors.textColor,this.ctx.textAlign="left",this.ctx.fillText(i.label,s+25,a),a+=25}),this.ctx.restore()}handleResize(){this.setupCanvas()}notifyViewSwitch(){this.lastViewSwitchTime=performance.now(),console.log("PlotRenderer: View switch notification received")}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),clearTimeout(this.resizeTimeout)}exportPlotData(){const t=["Time (ms)","Substrate (mM)","Product (mM)"],e=this.timePoints.map((a,i)=>{var o,s;return[a.toFixed(3),((o=this.substrateData[i])==null?void 0:o.toFixed(3))||"0.000",((s=this.productData[i])==null?void 0:s.toFixed(3))||"0.000"]});return[t,...e]}}class wt{constructor(t){if(!t)throw new Error("VelocityProfileGenerator requires a valid particleSimulator");this.particleSimulator=t,this.isGenerating=!1,this.profileData=[],console.log("VelocityProfileGenerator constructor - particleSimulator valid:",!!t),console.log("VelocityProfileGenerator constructor - particleSimulator has setParameters:",typeof t.setParameters=="function"),console.log("VelocityProfileGenerator constructor - particleSimulator has simulateStepForPreCalculation:",typeof t.simulateStepForPreCalculation=="function")}async generateVelocityProfile(t,e=null){if(console.log("=== Starting generateVelocityProfile ==="),console.log("currentParameters received:",t),console.log("progressCallback provided:",typeof e),this.isGenerating)return console.warn("Velocity profile generation already in progress"),null;this.isGenerating=!0,this.profileData=[],console.log("Generation state set, isGenerating:",this.isGenerating);try{console.log("Starting velocity profile generation..."),console.log("Initial simulator state:",{time:this.particleSimulator.time,playbackMode:this.particleSimulator.playbackState.mode,isPreCalculating:this.particleSimulator.isPreCalculating,parameters:this.particleSimulator.parameters});const a={...this.particleSimulator.parameters};console.log("Stored original parameters:",a);const i=[];for(let n=5;n<=140;n+=5)i.push(n);console.log(`Testing ${i.length} substrate concentrations:`,i);const o=i.length*2;let s=0;for(let n=0;n<i.length;n++){const r=i[n];try{console.log(`Calculating velocity for substrate concentration: ${r} mM (2 runs for averaging)`);const l={...t,S_concentration:r};console.log("Setting parameters:",l),this.particleSimulator.setParameters(l),console.log("Parameters set. Current simulator params:",this.particleSimulator.parameters);const h=[];for(let f=0;f<2;f++)try{console.log(`  Run ${f+1}/2 for [S] = ${r} mM`);const p=await this.calculateVelocityForConcentration();if(isNaN(p)||p<0)throw console.warn(`Invalid velocity calculated: ${p} for [S] = ${r} mM, run ${f+1}`),new Error(`Invalid velocity: ${p}`);if(h.push(p),s++,e){const u=s/o*100;e(u,r,p,f+1)}await new Promise(u=>setTimeout(u,10))}catch(p){throw console.error(`Error in run ${f+1} for [S] = ${r} mM:`,p),p}if(h.length===0)throw new Error(`No valid velocities calculated for [S] = ${r} mM`);const m=h.reduce((f,p)=>f+p,0)/h.length;console.log(`  Individual velocities: [${h.map(f=>f.toFixed(4)).join(", ")}]`),console.log(`  Average velocity: ${m.toFixed(4)} mM/s`),this.profileData.push({substrateConcentration:r,velocity:m,individualVelocities:h,standardDeviation:this.calculateStandardDeviation(h)}),console.log(`Successfully calculated velocity for [S] = ${r} mM`)}catch(l){throw console.error(`Failed to calculate velocity for [S] = ${r} mM:`,l),new Error(`Velocity calculation failed for substrate concentration ${r} mM: ${l.message}`)}}return console.log("Restoring original parameters..."),this.particleSimulator.setParameters(a),this.particleSimulator.initializeObjects(),console.log(`Velocity profile generation completed successfully with ${this.profileData.length} data points`),console.log("Profile data summary:",this.profileData.map(n=>`[S]=${n.substrateConcentration}mM: V=${n.velocity.toFixed(6)}mM/s`)),console.log("=== generateVelocityProfile completed successfully ==="),console.log("Returning profile data with length:",this.profileData.length),this.profileData}catch(a){throw console.error("=== Error in generateVelocityProfile ==="),console.error("Error generating velocity profile:",a),console.error("Error type:",typeof a),console.error("Error constructor:",a.constructor.name),a}finally{console.log("=== generateVelocityProfile finally block ==="),this.isGenerating=!1,console.log("Generation state reset, isGenerating:",this.isGenerating)}}async calculateVelocityForConcentration(){try{const t=this.particleSimulator.time,e={...this.particleSimulator.playbackState};this.particleSimulator.time=0,this.particleSimulator.playbackState.currentTime=0,this.particleSimulator.playbackState.isPlaying=!1,this.particleSimulator.playbackState.mode="live",this.particleSimulator.initializeObjects();const a=this.particleSimulator.parameters.timeframe||500,i=this.particleSimulator.parameters.time_step||.01;console.log(`  Running simulation for ${a}ms with step ${i}ms`);let o=0;const s=Math.ceil(a/i)+100;for(;this.particleSimulator.time<a&&o<s;)if(this.particleSimulator.simulateStepForPreCalculation(i),this.particleSimulator.time+=i,o++,o%100===0){const l=this.particleSimulator.objects.filter(h=>h.type==="P").length;console.log(`    Step ${o}: time=${this.particleSimulator.time.toFixed(1)}ms, products=${l}`)}const n=this.particleSimulator.objects.filter(l=>l.type==="P").length;console.log(`  Final product count: ${n} particles`);const r=n*.1/(a/1e3);return console.log(`  Calculated velocity: ${r.toFixed(6)} mM/s`),this.particleSimulator.time=t,this.particleSimulator.playbackState=e,this.particleSimulator.initializeObjects(),r}catch(t){throw console.error("Error in calculateVelocityForConcentration:",t),t}}calculateStandardDeviation(t){if(t.length<2)return 0;const e=t.reduce((o,s)=>o+s,0)/t.length,i=t.map(o=>Math.pow(o-e,2)).reduce((o,s)=>o+s,0)/t.length;return Math.sqrt(i)}exportToCSV(){if(this.profileData.length===0)return console.warn("No velocity profile data to export"),null;let t=`Substrate Concentration (mM),Average Velocity (mM/s),Standard Deviation,Run 1 Velocity,Run 2 Velocity
`;return this.profileData.forEach(e=>{const a=e.individualVelocities||[e.velocity,e.velocity],i=e.standardDeviation||0;t+=`${e.substrateConcentration},${e.velocity.toFixed(6)},${i.toFixed(6)},${a[0].toFixed(6)},${a[1].toFixed(6)}
`}),t}downloadCSV(t="velocity_profile.csv"){const e=this.exportToCSV();if(!e)return;const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");if(i.download!==void 0){const o=URL.createObjectURL(a);i.setAttribute("href",o),i.setAttribute("download",t),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}getProfileData(){return[...this.profileData]}isGeneratingProfile(){return this.isGenerating}}const d={currentView:"molecular",isSimulationRunning:!1,isSwitchingViews:!1,simulationMode:"playback",lastViewSwitchTime:null,parameters:{substrate:5,enzyme:.1,inhibitor:0,inhibitionType:"none"}};window.appState=d;function O(){try{const c={substrate:d.parameters.substrate,enzyme:d.parameters.enzyme,inhibitor:d.parameters.inhibitor,inhibitionType:d.parameters.inhibitionType};localStorage.setItem("enzymeKineticsParameters",JSON.stringify(c)),console.log("Parameters saved to localStorage:",c)}catch(c){console.warn("Failed to save parameters to localStorage:",c)}}function Pt(){try{const c=localStorage.getItem("enzymeKineticsParameters");if(c){const t=JSON.parse(c);return typeof t.substrate=="number"&&t.substrate>=0&&t.substrate<=140&&(d.parameters.substrate=t.substrate),typeof t.enzyme=="number"&&t.enzyme>=0&&t.enzyme<=1&&(d.parameters.enzyme=t.enzyme),typeof t.inhibitor=="number"&&t.inhibitor>=0&&t.inhibitor<=35&&(d.parameters.inhibitor=t.inhibitor),t.inhibitionType&&["none","competitive","uncompetitive","noncompetitive"].includes(t.inhibitionType)&&(d.parameters.inhibitionType=t.inhibitionType),console.log("Parameters loaded from localStorage:",d.parameters),!0}}catch(c){console.warn("Failed to load parameters from localStorage:",c)}return!1}function Mt(){G&&q&&(G.value=d.parameters.substrate,q.textContent=`${d.parameters.substrate.toFixed(1)} mM`),j&&U&&(j.value=d.parameters.enzyme,U.textContent=`${d.parameters.enzyme.toFixed(2)} mM`),ct.forEach(c=>{c.checked=c.value===d.parameters.inhibitionType}),L&&(L.value=d.parameters.inhibitionType),$&&N&&($.value=d.parameters.inhibitor,N.textContent=`${d.parameters.inhibitor.toFixed(1)} mM`,$.disabled=d.parameters.inhibitionType==="none"),console.log("UI updated with current parameters")}let _,g,w,C,R;const Z=document.getElementById("molecular-view-btn"),Q=document.getElementById("plots-view-btn"),G=document.getElementById("substrate-slider"),q=document.getElementById("substrate-value"),j=document.getElementById("enzyme-slider"),U=document.getElementById("enzyme-value"),ct=document.querySelectorAll('input[name="inhibitor-type"]'),L=document.getElementById("inhibitor-select"),$=document.getElementById("inhibitor-slider"),N=document.getElementById("inhibitor-value"),E=document.getElementById("export-btn"),T=document.getElementById("generate-profile-btn"),I=document.getElementById("toggle-graph-btn"),v=document.getElementById("play-pause-btn-bottom"),rt=document.getElementById("reset-btn-bottom"),M=document.getElementById("playback-time-slider-bottom"),k=document.getElementById("playback-time-value-bottom"),D=document.getElementById("molecular-canvas"),H=document.getElementById("plots-canvas"),Ct=document.getElementById("current-velocity"),Et=document.getElementById("current-product");function Tt(){try{if(!D)return console.error("Molecular canvas element not found"),!1;if(!H)return console.error("Plots canvas element not found"),!1;_=new xt;const c=D.getBoundingClientRect();g=new bt({canvas_width:c.width||800,canvas_height:c.height||400}),g.switchToPlaybackMode();const t=()=>{d.isSwitchingViews?console.log("View switch in progress - skipping resize reset"):(console.log("Window resize detected - resetting simulation"),K())};try{w=new St(D,t);const e=D.getBoundingClientRect();g.setParameters({canvas_width:e.width||800,canvas_height:e.height||400})}catch(e){return console.error("Failed to create molecular renderer:",e),!1}try{C=new vt(H,t)}catch(e){return console.error("Failed to create plot renderer:",e),!1}return B(),J(),W(),g.onObjectsInitialized=()=>{w&&(d.currentView==="molecular"||d.currentView==="split")&&(w.renderSingleFrame(g),console.log("Rendered initial frame with",g.objects.length,"molecules"))},g.initializeObjects(),Dt(),console.log("Initializing VelocityProfileGenerator with particleSimulator:",!!g),R=new wt(g),console.log("VelocityProfileGenerator initialized:",!!R),window.velocityProfileData=null,window.velocityProfileChartVisible=!1,console.log("Enzyme Kinetics Simulator initialized successfully"),!0}catch(c){return console.error("Failed to initialize simulation:",c),!1}}function Dt(){X()}function Y(c){return`${Math.round(c)}ms`}function X(){const c=g&&g.preCalculatedData.isGenerated,t=c||d.isSimulationRunning;if(M&&(M.disabled=!t),c){const e=g.playbackState.currentTime,a=g.preCalculatedData.totalDuration;if(M&&(M.value=e,M.max=a),k){const i=Y(e),o=Y(a);k.textContent=`${i} / ${o}`}}else d.isSimulationRunning&&k&&(k.textContent="Loading...")}async function It(){try{console.log("Starting automatic pre-calculation..."),g.isPreCalculating=!1,g.preCalculatedData.isGenerated=!1,v&&(v.disabled=!0,v.classList.add("loading"),v.textContent="0%");const c=e=>{console.log(`Pre-calculation progress: ${e.toFixed(1)}%`),v&&(v.textContent=`${Math.round(e)}%`)};if(!await g.preCalculateSimulation(c)){console.log("Pre-calculation was cancelled"),v&&(v.disabled=!1,v.classList.remove("loading"),v.textContent="▶");return}console.log("Pre-calculation completed successfully"),J(),v&&(v.disabled=!1,v.classList.remove("loading"),v.textContent="⏸"),g.switchToPlaybackMode(),g.playPlayback(),X(),W(),d.isSimulationRunning=!0,dt(),console.log("Pre-calculation and playback startup complete")}catch(c){console.error("Pre-calculation failed:",c),v&&(v.classList.remove("loading"),v.textContent="▶",v.disabled=!1),g&&(g.isPreCalculating=!1)}}function B(){const c=d.isSimulationRunning;_.updateSubstrateConcentration(d.parameters.substrate),_.updateEnzymeConcentration(d.parameters.enzyme),_.updateInhibitorConcentration(d.parameters.inhibitor),_.updateInhibitionType(d.parameters.inhibitionType);const t={none:"None",competitive:"Competitive",uncompetitive:"Un-competitive",noncompetitive:"Non-competitive"},e=D.getBoundingClientRect(),a=e.width>0&&e.height>0,i={S_concentration:d.parameters.substrate,E_concentration:d.parameters.enzyme,I_concentration:d.parameters.inhibitor,inhibitor_type:t[d.parameters.inhibitionType]||"None"};a?(i.canvas_width=Math.max(e.width,300),i.canvas_height=Math.max(e.height,200),console.log(`Updating canvas dimensions from visible molecular canvas: ${i.canvas_width}x${i.canvas_height}`)):console.log("Molecular canvas hidden or zero-sized, preserving existing canvas dimensions"),g.setParameters(i),$.disabled=d.parameters.inhibitionType==="none",d.parameters.inhibitionType==="none"&&(d.parameters.inhibitor=0,$.value=0,N.textContent="0.0 mM",_.updateInhibitorConcentration(0),g.setParameters({I_concentration:0,inhibitor_type:"None"})),c&&console.log("Parameters changed during simulation - stopping and resetting to initial frame"),K()}function J(){const t=g.getSummary().P||0,e=t/10;let a=0;if(g.preCalculatedData.isGenerated){const i=g.playbackState.currentTime;i>0&&t>0&&(a=t*.1/i)}Ct.textContent=`${a.toFixed(4)} mM·ms⁻¹`,Et.textContent=`${e.toFixed(1)} mM`}function W(){d.isSwitchingViews=!0,d.lastViewSwitchTime=performance.now(),console.log(`Switching to view: ${d.currentView}, simulation running: ${d.isSimulationRunning}`),w&&w.notifyViewSwitch(),C&&C.notifyViewSwitch();const c=window.innerWidth,t=g?g.objects.length:0;let e,a,i;const o=Math.min(1.5,1+t/1e3);c<=768?(e=Math.round(100*o),a=Math.round(800*o),i="mobile"):c<=1200?(e=Math.round(75*o),a=Math.round(600*o),i="tablet"):(e=Math.round(50*o),a=Math.round(400*o),i="desktop"),console.log(`Device: ${i} (${c}px), Objects: ${t}, Delays: ${e}ms initial, ${a}ms protection`),D.style.display="none",H.style.display="none",w.stopAnimation(),C.stopAnimation(),setTimeout(()=>{switch(d.currentView){case"molecular":D.style.display="block",setTimeout(()=>{w.handleResize();const s=D.getBoundingClientRect(),n=Math.max(s.width||800,300),r=Math.max(s.height||400,200);g.setParameters({canvas_width:n,canvas_height:r}),console.log(`Updated particle simulator canvas dimensions: ${n}x${r}`),d.isSimulationRunning?w.startAnimation(g):setTimeout(()=>{w.renderSingleFrame(g)},10)},5);break;case"plots":H.style.display="block",setTimeout(()=>{C.handleResize(),d.isSimulationRunning?C.startAnimation(g):setTimeout(()=>{C.loadSimulationData(g),C.render(g,performance.now())},10)},5);break}setTimeout(()=>{d.isSwitchingViews=!1,d.lastViewSwitchTime=performance.now(),console.log("View switch complete - resize protection cleared")},a)},e)}function tt(){Z.classList.remove("active"),Q.classList.remove("active"),d.currentView==="molecular"?Z.classList.add("active"):d.currentView==="plots"&&Q.classList.add("active")}async function ht(){if(!_||!g||!w||!C){console.error("Simulation components not properly initialized"),et("Simulation not ready. Please refresh the page.");return}if(d.isSimulationRunning=!0,g.isPreCalculating=!1,g.preCalculatedData.isGenerated)console.log("Using existing pre-calculated data for playback..."),g.playPlayback(),W(),dt(),v&&(v.innerHTML="⏸",v.classList.remove("primary"),v.classList.add("secondary"));else{console.log("No pre-calculated data available, starting pre-calculation..."),await It();return}}function it(){d.isSimulationRunning=!1,_&&_.pause(),g&&g.pause(),w&&w.stopAnimation(),C&&C.stopAnimation(),v&&(v.innerHTML="▶",v.classList.remove("secondary"),v.classList.add("primary"))}function K(){if(it(),performance.memory){const c=Math.round(performance.memory.usedJSHeapSize/1024/1024);console.log(`Memory before reset: ${c}MB`)}_.reset(),g.reset(),w.reset(),C.reset(),M&&(M.value=0),k&&(k.textContent="0ms / 500ms"),g.setPlaybackTime(0),window.velocityProfileData=null,window.velocityProfileChartVisible=!1,I&&(I.textContent="Show Chart"),w&&d.currentView==="molecular"&&w.renderSingleFrame(g),J(),X(),setTimeout(()=>{if(performance.memory){const c=Math.round(performance.memory.usedJSHeapSize/1024/1024);console.log(`Memory after reset: ${c}MB`)}window.gc&&typeof window.gc=="function"&&(window.gc(),console.log("Forced garbage collection (dev mode)"))},100),console.log("Simulation reset")}function dt(){console.log("Simulation started - updates handled by active renderer")}async function _t(){const c=Date.now();try{E&&(E.textContent="0%",E.disabled=!0,E.classList.add("loading")),console.log("Preparing particle simulation data for export...");const t=D.getBoundingClientRect();if(t.width>0&&t.height>0){const p=Math.max(t.width,300),u=Math.max(t.height,200);g.setParameters({canvas_width:p,canvas_height:u}),console.log(`Updated particle simulator canvas dimensions for export: ${p}x${u}`)}const e=d.isSimulationRunning;if(e&&it(),!g.preCalculatedData.isGenerated){console.log("Pre-calculating simulation data for export...");const p=window.innerWidth<768,u=performance.memory?Math.round(performance.memory.usedJSHeapSize/1024/1024):0;p&&u>50&&(console.warn(`High memory usage detected before export: ${u}MB`),window.gc&&typeof window.gc=="function"&&(window.gc(),console.log("Forced garbage collection before export")));const y=S=>{console.log(`Export pre-calculation progress: ${S.toFixed(1)}%`),E&&(E.textContent=`${Math.round(S)}%`)},b=g.preCalculateSimulation(y),x=p?9e4:6e4;try{await Promise.race([b,new Promise((S,P)=>setTimeout(()=>P(new Error(`Pre-calculation timeout (${x/1e3}s) - device may have insufficient memory`)),x))])}catch(S){throw S.message.includes("timeout")?new Error(`Export failed: ${S.message}. Try reducing substrate/enzyme concentrations or using a desktop device.`):S}}E&&(E.textContent="Processing...");const a=g.preCalculatedData.averagedData||g.preCalculatedData.summaryData;if(!a||a.length===0)throw new Error("No simulation data available");console.log("Using averaged data for export:",a.length,"time points from",g.preCalculatedData.individualRuns?g.preCalculatedData.individualRuns.length:1,"runs");const i=[],o=10,s=Math.round(d.parameters.substrate*o),n=Math.round(d.parameters.enzyme*o),r=d.parameters.inhibitionType==="none"?0:Math.round(d.parameters.inhibitor*o);for(let p=1;p<=500;p++){let u=null,y=1/0;for(const[gt,yt]of a){const nt=Math.abs(gt-p);nt<y&&(y=nt,u=yt)}u||(u={E:n,S:s,I:r,P:0,ES:0,EI:0,ESI:0});const b=u.S||0,x=u.E||0,S=u.I||0,P=u.P||0,z=u.ES||0,F=u.EI||0,V=u.ESI||0,A=b+z+V,at=x+z+F+V,ot=S+F+V,ut=A/o,mt=at/o,pt=ot/o,ft=P/o;let st=0;p>0&&P>0&&(st=P*.1/p),i.push({time:p,substrateObjects:A,substrateConcentration:ut.toFixed(3),enzymeObjects:at,enzymeConcentration:mt.toFixed(3),inhibitorObjects:ot,inhibitorConcentration:pt.toFixed(3),productObjects:P,productConcentration:ft.toFixed(3),velocity:st.toFixed(4)})}let l=0,h=0;i.forEach(p=>{const u=parseFloat(p.velocity);u>0&&(l+=u,h++)});const m=h>0?(l/h).toFixed(4):"0.0000";let f=`time(ms),substrate(objects),substrate_concentration(mM),enzyme(objects),enzyme_concentration(mM),inhibitor(objects),inhibitor_concentration(mM),product(objects),product_concentration(mM),velocity,average_velocity
`;i.forEach((p,u)=>{const y=u===0?m:"";f+=`${p.time},${p.substrateObjects},${p.substrateConcentration},${p.enzymeObjects},${p.enzymeConcentration},${p.inhibitorObjects},${p.inhibitorConcentration},${p.productObjects},${p.productConcentration},${p.velocity},${y}
`}),kt(f,`enzyme_export_data_${c}.csv`),console.log(`Export completed - ${i.length} data points exported (1-500ms)`),e&&ht()}catch(t){console.error("Export failed:",t);const e=window.innerWidth,a=e<768,i=e>=768&&e<1200;let o="Export failed. ";t.message.includes("timeout")?o+=t.message:t.message.includes("memory")||t.message.includes("quota")?a?o+="Insufficient memory on mobile device. Try reducing parameter values or use a desktop computer.":i?o+="Insufficient memory on tablet device. Try reducing parameter values or use a desktop computer.":o+="Insufficient memory. Try reducing parameter values.":t.message.includes("No simulation data")?o+="No simulation data available. Please run the simulation first.":t.message.includes("Blob")||t.message.includes("download")?o+="Download failed. Your browser may not support file downloads or storage is full.":o+=`Error: ${t.message}. Please try again.`,alert(o)}finally{E&&(E.textContent="Export",E.disabled=!1,E.classList.remove("loading"))}}function kt(c,t){try{const e=new Blob([c],{type:"text/csv;charset=utf-8;"});if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{const a=URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",a),i.setAttribute("download",t),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>URL.revokeObjectURL(a),100)}console.log(`CSV export completed: ${t} (${(e.size/1024/1024).toFixed(2)}MB)`)}catch(e){if(console.error("CSV download failed:",e),c.length<1e6){console.warn("Falling back to data URI method for small file");const a=encodeURI("data:text/csv;charset=utf-8,"+c),i=document.createElement("a");i.setAttribute("href",a),i.setAttribute("download",t),document.body.appendChild(i),i.click(),document.body.removeChild(i)}else throw new Error("Export failed: File too large for mobile browser and Blob method failed")}}function Rt(){Z.addEventListener("click",()=>{d.currentView="molecular",tt(),W(),console.log("View mode changed to: molecular")}),Q.addEventListener("click",()=>{d.currentView="plots",tt(),W(),console.log("View mode changed to: plots")}),G.addEventListener("input",c=>{const t=parseFloat(c.target.value);d.parameters.substrate=t,q.textContent=`${t.toFixed(1)} mM`}),G.addEventListener("change",c=>{const t=parseFloat(c.target.value);B(),O(),console.log(`Substrate concentration: ${t} mM`)}),j.addEventListener("input",c=>{const t=parseFloat(c.target.value);d.parameters.enzyme=t,U.textContent=`${t.toFixed(2)} mM`}),j.addEventListener("change",c=>{const t=parseFloat(c.target.value);B(),O(),console.log(`Enzyme concentration: ${t} mM`)}),ct.forEach(c=>{c.addEventListener("change",t=>{t.target.checked&&(d.parameters.inhibitionType=t.target.value,B(),O(),console.log(`Inhibition type: ${t.target.value}`))})}),L&&L.addEventListener("change",c=>{d.parameters.inhibitionType=c.target.value;const t=document.querySelector(`input[name="inhibitor-type"][value="${c.target.value}"]`);t&&(t.checked=!0),B(),O()}),$.addEventListener("input",c=>{const t=parseFloat(c.target.value);d.parameters.inhibitor=t,N.textContent=`${t.toFixed(1)} mM`}),$.addEventListener("change",c=>{const t=parseFloat(c.target.value);B(),O(),console.log(`Inhibitor concentration: ${t} mM`)}),E.addEventListener("click",()=>{_t()}),T&&T.addEventListener("click",()=>{zt()}),I&&I.addEventListener("click",()=>{Vt()}),v&&v.addEventListener("click",()=>{d.isSimulationRunning?it():ht()}),rt&&rt.addEventListener("click",()=>{K()}),M&&M.addEventListener("input",c=>{const t=parseFloat(c.target.value);if(g.setPlaybackTime(t),k){const e=g.preCalculatedData.totalDuration||500,a=Y(t),i=Y(e);k.textContent=`${a} / ${i}`}}),window.addEventListener("resize",()=>{clearTimeout(window.resizeTimeout),window.resizeTimeout=setTimeout(()=>{w&&w.handleResize(),C&&C.handleResize(),console.log("Window resize handled")},100)})}function $t(){G.value=d.parameters.substrate,q.textContent=`${d.parameters.substrate.toFixed(1)} mM`,j.value=d.parameters.enzyme,U.textContent=`${d.parameters.enzyme.toFixed(2)} mM`,$.value=d.parameters.inhibitor,N.textContent=`${d.parameters.inhibitor.toFixed(1)} mM`,tt();const c=document.querySelector(`input[name="inhibitor-type"][value="${d.parameters.inhibitionType}"]`);c&&(c.checked=!0),L&&(L.value=d.parameters.inhibitionType),T&&(T.textContent="Generate Profile",T.disabled=!1),I&&(I.textContent="Show Chart"),M&&(M.min=0,M.max=500,M.value=0,M.step=.1,M.disabled=!0),k&&(k.textContent="0ms / 500ms"),console.log("UI initialized with default values")}async function zt(){if(console.log("generateVelocityProfile called"),console.log("velocityProfileGenerator exists:",!!R),console.log("velocityProfileGenerator.isGeneratingProfile:",R?R.isGeneratingProfile():"N/A"),console.log("particleSimulator exists:",!!g),!R){console.error("VelocityProfileGenerator not initialized"),alert("Velocity profile generator is not initialized. Please refresh the page and try again.");return}if(R.isGeneratingProfile()){console.warn("Velocity profile generation already in progress");return}try{T&&(T.disabled=!0,T.textContent="Generating...");const c={E_concentration:d.parameters.enzyme,I_concentration:d.parameters.inhibitor,inhibitor_type:{none:"None",competitive:"Competitive",uncompetitive:"Un-competitive",noncompetitive:"Non-competitive"}[d.parameters.inhibitionType]||"None",canvas_width:D.getBoundingClientRect().width||800,canvas_height:D.getBoundingClientRect().height||400},t=(a,i,o,s=null)=>{try{if(T){const r=s?` (Run ${s}/2)`:"";T.textContent=`Generating... ${a.toFixed(0)}%${r}`}const n=s?` (Run ${s}/2)`:"";console.log(`Progress: ${a.toFixed(1)}% - [S]: ${i} mM, V: ${o.toFixed(4)} mM/s${n}`)}catch(n){console.error("Error in progress callback:",n)}};console.log("Calling velocityProfileGenerator.generateVelocityProfile with params:",c);const e=await R.generateVelocityProfile(c,t);if(console.log("Generation completed. Profile data:",e),e&&e.length>0){window.velocityProfileData=e,window.velocityProfileChartVisible=!0,I&&(I.textContent="Hide Chart");const a=new Date().toISOString().replace(/[:.]/g,"-"),i=`E${c.E_concentration}mM`,o=c.inhibitor_type.replace(/[^a-zA-Z0-9]/g,""),s=c.I_concentration>0?`_I${c.I_concentration}mM`:"",n=`velocity_profile_${i}_${o}${s}_${a}.csv`;R.downloadCSV(n);const r=`velocity_profile_chart_${i}_${o}${s}_${a}.png`;w&&w.exportVelocityChartAsPNG(r),console.log(`Velocity profile generated with ${e.length} data points`),console.log("Chart data stored globally"),console.log("Sample data points:",e.slice(0,3))}}catch(c){console.error("Error generating velocity profile:",c),console.error("Error stack:",c.stack),console.error("Error message:",c.message);let t="Failed to generate velocity profile. ";c.message?t+=`Error: ${c.message}`:t+="Please check the console for details and try again.",alert(t)}finally{T&&(T.disabled=!1,T.textContent="Generate Profile")}}function Vt(){if(!window.velocityProfileData||window.velocityProfileData.length===0){console.warn("No velocity profile data available. Generate a profile first.");return}window.velocityProfileChartVisible=!window.velocityProfileChartVisible,I&&(I.textContent=window.velocityProfileChartVisible?"Hide Chart":"Show Chart"),console.log("Velocity chart toggled to:",window.velocityProfileChartVisible?"visible":"hidden"),w&&(d.currentView==="molecular"||d.currentView==="split")&&(d.isSimulationRunning?console.log("Chart will update in next animation frame"):setTimeout(()=>{w.renderSingleFrame(g),console.log("Canvas manually refreshed to show chart changes")},10))}function Ft(){console.log("=== CHART DEBUG INFO ==="),console.log("velocityProfileData exists:",!!window.velocityProfileData),console.log("velocityProfileData length:",window.velocityProfileData?window.velocityProfileData.length:"null"),console.log("velocityProfileChartVisible:",window.velocityProfileChartVisible),console.log("Toggle button text:",I?I.textContent:"button not found"),console.log("App state - simulation running:",d.isSimulationRunning),console.log("App state - current view:",d.currentView),console.log("Molecular canvas exists:",!!D),console.log("Molecular renderer exists:",!!w),w&&g&&(console.log("Triggering manual render..."),w.renderSingleFrame(g)),console.log("=======================")}window.testChartRendering=Ft;function lt(){console.log("Michaelis-Menten Enzyme Kinetics Simulator - Starting...");try{Pt(),$t(),Mt(),Rt(),Tt()?console.log("Enzyme Kinetics Simulator - Ready!"):(console.error("Failed to initialize simulation components"),et("Failed to initialize simulation. Please refresh the page."))}catch(c){console.error("Failed to initialize enzyme kinetics simulator:",c),et("Application failed to load. Please check the console for details.")}}function et(c){const t=document.getElementById("main-content");t&&(t.innerHTML=`
            <div style="
                display: flex; 
                justify-content: center; 
                align-items: center; 
                height: 100%; 
                flex-direction: column;
                text-align: center;
                color: #e74c3c;
                font-family: 'Nunito', sans-serif;
            ">
                <h2>⚠️ Error</h2>
                <p>${c}</p>
                <button onclick="location.reload()" style="
                    padding: 10px 20px;
                    margin-top: 20px;
                    background: #3c78d8;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                ">Refresh Page</button>
            </div>
        `)}window.updatePlaybackControlsState=X;window.updateParameterDisplay=J;window.getSimulationMemoryStats=function(){if(g){const c=g.getMemoryStats();if(console.log("=== SIMULATION MEMORY STATS ==="),console.log("Current objects:",c.objectCount),console.log(""),console.log("ESSENTIAL DATA (needed for functionality):"),console.log("  Time points:",c.timePointsCount,"(needed for both views)"),console.log("  Particle data frames:",c.particleDataCount,"(essential for molecular view)"),console.log("  Summary data frames:",c.summaryDataCount,"(essential for plot view)"),console.log("  Averaged data frames:",c.averagedDataCount,"(essential for CSV export)"),console.log(""),console.log("TEMPORARY DATA (cleared between sims):"),console.log("  Data log entries:",c.dataLogTime+c.dataLogMolecular+c.dataLogSummary),console.log(""),console.log("STATUS:"),console.log("  Pre-calculating:",c.isPreCalculating),console.log("  Data generated:",c.isGenerated),console.log("  Memory leak indicator:",c.hasIndividualRuns?"❌ LEAK DETECTED!":"✅ No leak"),console.log(""),console.log("MEMORY USAGE:"),console.log("  Estimated simulation data:",c.estimatedMemoryMB+"MB"),performance.memory){const t=Math.round(performance.memory.usedJSHeapSize/1024/1024);console.log("  Total JS heap:",t+"MB")}return console.log("==============================="),c}else return console.log("Particle simulator not available"),null};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",lt):lt();
//# sourceMappingURL=index-CIleXYA7.js.map</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #3c78d8;--secondary-color: #6c757d;--success-color: #28a745;--background-color: #f0f8ff;--panel-background: #ffffff;--text-color: #333;--shadow-color: rgba(0, 0, 0, .1);--border-color: #dee2e6}body{font-family:Nunito,sans-serif;display:flex;height:100vh;background-color:var(--background-color);margin:0;overflow:hidden}#app-container{display:flex;width:100%;height:100%;overflow:hidden}#controls-panel{width:320px;background:var(--panel-background);box-shadow:2px 0 15px var(--shadow-color);padding:25px;z-index:100;display:flex;flex-direction:column;overflow-y:auto}.control-panel-title{color:var(--text-color);text-align:center;font-size:1.8em;margin-bottom:30px;border-bottom:3px solid var(--primary-color);padding-bottom:15px}#logo{width:100px;margin:0 auto 20px}#main-content{flex-grow:1;position:relative;background-color:var(--background-color);overflow:hidden;display:flex;flex-direction:column;padding:0}#simulation-container{flex:1;position:relative;padding:20px;display:flex;flex-direction:column;min-height:0;height:100%;box-sizing:border-box}.visualization-canvas{width:100%;flex:1;min-height:400px;max-height:calc(100vh - 170px);border:2px solid var(--border-color);border-radius:8px 8px 0 0;background:#fff;box-shadow:0 4px 12px var(--shadow-color);display:block;box-sizing:border-box}#molecular-canvas{display:block}#plots-canvas{display:none}#kinetic-parameters{position:absolute;top:100px;right:30px;background:#fffffff2;padding:15px;border-radius:8px;box-shadow:0 4px 12px var(--shadow-color);min-width:200px;z-index:10;order:initial}.visualization-canvas{order:initial}.parameter-display{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #eee}.parameter-display:last-child{border-bottom:none}.param-label{font-weight:600;color:#666}.parameter-display span:last-child{font-weight:700;color:var(--primary-color);font-family:Courier New,monospace}#video-controls{position:absolute;bottom:20px;left:20px;right:20px;background:#000c;border-bottom-left-radius:8px;border-bottom-right-radius:8px;z-index:15;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);box-sizing:border-box}.video-control-bar{display:flex;align-items:center;padding:12px 16px;gap:15px}.control-buttons{display:flex;gap:8px;align-items:center}.video-btn{background:none;border:none;color:#fff;font-size:18px;padding:8px;border-radius:50%;cursor:pointer;transition:background-color .2s;width:40px;height:40px;display:flex;align-items:center;justify-content:center}.video-btn:hover{background:#ffffff1a}.video-btn.primary{background:var(--primary-color)}.video-btn.primary:hover{background:var(--accent-color)}#play-pause-btn-bottom.loading,#export-btn.loading{font-size:13.5px}.progress-container{flex:1;margin:0 15px}.progress-bar{width:100%;height:6px;-webkit-appearance:none;-moz-appearance:none;appearance:none;background:#ffffff4d;border-radius:3px;outline:none;cursor:pointer}.progress-bar::-webkit-slider-thumb{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary-color);cursor:pointer;border:2px solid white;box-shadow:0 2px 4px #0000004d}.progress-bar::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--primary-color);cursor:pointer;border:2px solid white;box-shadow:0 2px 4px #0000004d}.progress-bar:disabled{opacity:.5;cursor:not-allowed}.time-display{color:#fff;font-family:Courier New,monospace;font-size:14px;font-weight:500;min-width:100px;text-align:right}@media (max-width: 768px){#video-controls{left:10px;right:10px;bottom:10px}.video-control-bar{padding:10px 12px;gap:12px}.video-btn{font-size:16px;width:36px;height:36px}.progress-container{margin:0 10px}.time-display{font-size:12px;min-width:80px}}@media (max-width: 480px){.video-control-bar{padding:8px 10px;gap:8px}.video-btn{font-size:14px;width:32px;height:32px}.progress-container{margin:0 8px}.time-display{font-size:11px;min-width:70px}}.control-group{margin-bottom:25px}.control-group label{display:block;margin-bottom:10px;font-weight:700;color:#555}.inhibition-group{background:#f8f9fa;padding:15px;border-radius:8px;border:1px solid var(--border-color);margin-bottom:25px}.inhibition-group .control-group:last-child{margin-bottom:0}input[type=range]{width:100%;-webkit-appearance:none;-moz-appearance:none;appearance:none;height:15px;border-radius:8px;background:var(--primary-color);outline:none;transition:opacity .2s}#substrate-slider{background:linear-gradient(to right,#90ee90,#228b22)}#enzyme-slider{background:linear-gradient(to right,#87ceeb,#1e3a8a)}#inhibitor-slider{background:linear-gradient(to right,#ffb6c1,#dc143c)}input[type=range]:disabled{opacity:.4;cursor:not-allowed}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #fff;box-shadow:0 0 5px #0000004d}input[type=range]::-moz-range-thumb{width:25px;height:25px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #fff;box-shadow:0 0 5px #0000004d}.radio-group{display:flex;flex-direction:column;gap:8px}.radio-option{display:flex;align-items:center;gap:8px}.radio-option input[type=radio]{width:18px;height:18px;accent-color:var(--primary-color)}.inhibition-group .radio-option input[type=radio]{accent-color:#DC143C}.radio-option label{margin:0;font-weight:600;color:#666;cursor:pointer}.button-group{display:flex;gap:10px}.control-btn{flex:1;padding:12px 16px;border:none;border-radius:6px;font-size:1em;font-weight:700;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:5px}.control-btn.primary{background-color:var(--success-color);color:#fff}.control-btn.primary:hover{background-color:#218838;transform:translateY(-1px)}.control-btn.secondary{background-color:var(--secondary-color);color:#fff}.control-btn.secondary:hover{background-color:#5a6268;transform:translateY(-1px)}.control-btn.danger{background-color:#dc3545;color:#fff}.control-btn.danger:hover{background-color:#c82333;transform:translateY(-1px)}.control-btn.action{background-color:var(--primary-color);color:#fff}.horizontal-buttons{display:flex;gap:10px;width:100%}.horizontal-buttons .control-btn{flex:1;padding:12px 8px;font-size:.9em}.action-btn:active{transform:translateY(1px)}.toggle-group{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0}.toggle-label{font-size:14px;color:#555;font-weight:600}.toggle-switch{position:relative;display:inline-block;width:60px;height:30px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.3s;border-radius:30px}.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:#fff;transition:.3s;border-radius:50%}.toggle-switch input:checked+.toggle-slider{background-color:#f39c12}.toggle-switch input:checked+.toggle-slider:before{transform:translate(30px)}.playback-controls{border-top:2px solid #e9ecef;padding-top:15px;margin-top:15px}.playback-controls label{color:#666;font-size:14px}.playback-controls input[type=range]:disabled{opacity:.5;cursor:not-allowed}select{width:100%;padding:10px;margin-bottom:10px;border:2px solid #ddd;border-radius:6px;background-color:#fff;font-size:1em;font-weight:600;color:var(--text-color);cursor:pointer}select:focus{outline:none;border-color:var(--primary-color)}#view-select,#inhibitor-select{display:none}.desktop-only{display:block}#molecular-canvas.split,#plots-canvas.split{width:50%}#view-mode-controls{display:flex;justify-content:center;margin-bottom:15px;gap:0;background:var(--panel-background);border-radius:8px;padding:5px;box-shadow:0 2px 8px var(--shadow-color)}.view-mode-btn{flex:1;padding:12px 20px;border:none;background:transparent;color:var(--secondary-color);font-family:Nunito,sans-serif;font-weight:600;font-size:14px;cursor:pointer;transition:all .3s ease;border-radius:6px;position:relative}.view-mode-btn:first-child{border-top-right-radius:0;border-bottom-right-radius:0}.view-mode-btn:last-child{border-top-left-radius:0;border-bottom-left-radius:0}.view-mode-btn:hover{background:#3c78d81a;color:var(--primary-color)}.view-mode-btn.active{background:var(--primary-color);color:#fff;box-shadow:0 2px 4px #3c78d84d}.view-mode-btn.active:hover{background:var(--primary-color);color:#fff}@media (max-width: 768px){body{overflow:auto}#app-container{flex-direction:column-reverse;height:auto;overflow-y:auto;overflow-x:hidden}#controls-panel{width:auto;min-height:auto;padding:15px;box-shadow:0 2px 10px var(--shadow-color);overflow-y:visible}#main-content{min-height:60vh;width:100%;box-sizing:border-box;padding:0}#simulation-container{padding:10px;display:flex;flex-direction:column}.visualization-canvas{order:2}#view-mode-controls{order:0;margin-bottom:0}#kinetic-parameters{position:relative;top:auto;right:auto;margin-top:15px;margin-bottom:15px;order:1;width:100%;box-sizing:border-box}.control-group{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:nowrap}.control-group label{display:inline-block;margin-bottom:0;white-space:nowrap;font-weight:700;flex:0 0 auto;min-width:70px}.control-group input[type=range]{min-width:120px;flex:1}.button-group{flex-direction:column;gap:8px}.control-btn,.action-btn{width:100%;padding:10px 14px}.radio-group{flex-direction:row;flex-wrap:wrap;gap:10px;flex:1 1 auto;display:none}#view-select,#inhibitor-select{display:block!important;flex:1}.desktop-only{display:none}#logo{position:fixed;top:210px;right:20px;width:60px;z-index:1000}.inhibition-group{padding:10px;margin-bottom:15px}.visualization-canvas{min-height:300px;height:calc(100vh - 300px);max-height:none}.control-panel-title{font-size:1.4em;margin-bottom:20px}.parameter-display{padding:8px 0}.param-label{font-size:.9em}}@media (max-width: 480px){#controls-panel{padding:10px}.control-group{gap:8px;margin-bottom:10px}.control-group label{font-size:.9em;min-width:60px}#kinetic-parameters{padding:12px;min-width:auto;margin:10px 0;font-size:.9em}#logo{top:185px}.parameter-display{flex-direction:row;justify-content:space-between;align-items:center;padding:8px 0}.param-label{font-size:.85em;font-weight:600}.parameter-display span:last-child{font-weight:700;color:var(--primary-color)}.parameter-display span:last-child{font-weight:600}.visualization-canvas{min-height:250px;height:calc(100vh - 350px);max-height:none}.control-panel-title{font-size:1.2em;margin-bottom:15px}}@media print{#controls-panel{display:none}#main-content{width:100%;height:100vh}.visualization-canvas{width:100%;height:80vh;min-height:400px;max-height:none}}</style>
</head>
<body>
    <div id="app-container">
        <div id="controls-panel">
            <img id="logo" src="gsi-logo.png" alt="GSI Logo">
            <h2 class="control-panel-title">Enzyme Kinetics</h2>
            


            <!-- Substrate Concentration Control -->
            <div class="control-group">
                <label for="substrate-slider">Substrate: <span id="substrate-value">5.0 mM</span></label>
                <input type="range" id="substrate-slider" min="0" max="140" value="5.0" step="5">
            </div>

            <!-- Enzyme Concentration Control -->
            <div class="control-group">
                <label for="enzyme-slider">Enzyme: <span id="enzyme-value">0.10 mM</span></label>
                <input type="range" id="enzyme-slider" min="0" max="1.0" value="0.10" step="0.1">
            </div>

            <!-- Inhibition Controls grouped -->
            <div class="inhibition-group">
                <!-- Inhibitor Type Control -->
                <div class="control-group">
                    <label>Inhibitor Type</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="no-inhibition" name="inhibitor-type" value="none" checked>
                            <label for="no-inhibition">None</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="competitive" name="inhibitor-type" value="competitive">
                            <label for="competitive">Competitive</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="uncompetitive" name="inhibitor-type" value="uncompetitive">
                            <label for="uncompetitive">Uncompetitive</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="noncompetitive" name="inhibitor-type" value="noncompetitive">
                            <label for="noncompetitive">Non-competitive</label>
                        </div>
                    </div>
                    <!-- Mobile dropdown alternative -->
                    <select id="inhibitor-select">
                        <option value="none">None</option>
                        <option value="competitive">Competitive</option>
                        <option value="uncompetitive">Uncompetitive</option>
                        <option value="noncompetitive">Non-competitive</option>
                    </select>
                </div>

                <!-- Inhibitor Concentration Control -->
                <div class="control-group">
                    <label for="inhibitor-slider">Inhibitor: <span id="inhibitor-value">0.0 mM</span></label>
                    <input type="range" id="inhibitor-slider" min="0" max="35" value="0.0" step="1.0" disabled>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="control-group">
                <div class="button-group horizontal-buttons">
                    <button id="export-btn" class="control-btn action">Export</button>
                </div>
            </div>

            <!-- Velocity Analysis -->
            <div class="control-group">
                <label class="control-label">Velocity Analysis</label>
                <div class="button-group horizontal-buttons">
                    <button id="generate-profile-btn" class="control-btn primary">📊 Generate Profile</button>
                    <button id="toggle-graph-btn" class="control-btn secondary">Show Chart</button>
                </div>
            </div>


        </div>

        <main id="main-content">
            <div id="simulation-container">
                <!-- View Mode Controls -->
                <div id="view-mode-controls">
                    <button id="molecular-view-btn" class="view-mode-btn active" data-view="molecular">Molecular View</button>
                    <button id="plots-view-btn" class="view-mode-btn" data-view="plots">Plot View</button>
                </div>
                
                <!-- Canvas for molecular visualization -->
                <canvas id="molecular-canvas" class="visualization-canvas"></canvas>
                
                <!-- Canvas for kinetic plots -->
                <canvas id="plots-canvas" class="visualization-canvas"></canvas>
                
                <!-- Current kinetic parameters display -->
                <div id="kinetic-parameters">
                    <div class="parameter-display">
                        <span class="param-label">Velocity:</span>
                        <span id="current-velocity">0.0000 mM·ms⁻¹</span>
                    </div>
                    <div class="parameter-display">
                        <span class="param-label">Product:</span>
                        <span id="current-product">0.0 mM</span>
                    </div>
                </div>
                
                <!-- Bottom Video Player Controls -->
                <div id="video-controls">
                    <div class="video-control-bar">
                        <!-- Control Buttons (left side) -->
                        <div class="control-buttons">
                            <button id="play-pause-btn-bottom" class="video-btn primary">▶</button>
                            <button id="reset-btn-bottom" class="video-btn">⏹</button>
                        </div>
                        
                        <!-- Progress Bar (center) -->
                        <div class="progress-container">
                            <input type="range" id="playback-time-slider-bottom" class="progress-bar" min="0" max="60" value="0" step="0.1" disabled>
                        </div>
                        
                        <!-- Time Display (right side) -->
                        <div class="time-display">
                            <span id="playback-time-value-bottom">00:00 / 08:20</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>